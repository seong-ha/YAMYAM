<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mandu.yamyam.pro.mapper.ProMapper">
	<!-- 입력될 생산 우선순위 조회 -->
	<select id="getPrioNo" resultType="Integer">
		SELECT NVL(MAX(PPLND_PRIO),0)+1 as PPLND_PRIO FROM P_PLND
	</select>
	
	<!-- 생산계획조회 -->
	<select id="getPlan" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT TO_CHAR(ppln_date,'yyyy-MM-dd') AS ppln_date, ppln_cd, od_cd, ppln_name, ppln_sts
		from p_pln
		<where>
            <if test='startDate!= null and endDate != null'>
               TRUNC(PPLN_DATE) BETWEEN #{startDate}
                      AND #{endDate}
            </if>
        </where>
         ORDER BY PPLN_CD
	</select>
	
	
	<!-- 상세생산계획조회 -->
	<select id="getPlanDetail" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT P.PPLN_CD, P.PPLN_NAME, D.PPLND_CD, D.PRD_CD, D.PPLND_AMT, D.PPLND_PRIO, D.PPLND_DAYS, P.PPLN_STS, C.PRD_NM
		FROM P_PLN P JOIN P_PLND D
             		 ON P.PPLN_CD = D.PPLN_CD
             		 JOIN C_PRD C
             		 ON C.PRD_CD = D.PRD_CD
		WHERE P.PPLN_CD = #{pplnCd}            		 
		<where>
            <if test='startDate!= null and endDate != null'>
               TRUNC(P.PPLN_DATE) BETWEEN #{startDate}
                      AND #{endDate}
            </if>
        </where>
        ORDER BY P.PPLN_CD, D.PPLND_CD
        
	</select>
	
	
	<!-- 생산계획 등록 -->
	<insert id="insertPlan" parameterType="com.mandu.yamyam.pro.service.ProVO">
		insert into p_pln(
							<if test="pplnDate != null">
							ppln_date,
					 		</if>							
							ppln_cd,
							od_cd,
							ppln_name
							)
		
					values(
							<if test="pplnDate != null">
							#{pplnDate},
					 		</if>
							'PLN-'|| TO_CHAR(SYSDATE, 'yyyyMMdd-') || LPAD(ppln_seq.NEXTVAL, 3, 0),
							#{odCd},
							#{pplnName}
						   )
	</insert>
	
	
	<!-- 상세생산계획 등록 -->
	<select id="insertPlanDetail">
		
	</select>
	
	
	
	<!-- 생산계획 우선순위, 생산일자 수정 -->
	<update id="updatePlanDetail" parameterType="com.mandu.yamyam.pro.service.ProVO">
		UPDATE P_PLND
		   <set>
		   		<if test="pplndPrio != null">
		   			PPLND_PRIO = #{pplndPrio},
		   		</if>
		   		<if test="pplndDays != null">
		   			PPLND_DAYS = #{pplndDays}
		   		</if>
		   </set>
		 WHERE PPLND_CD = #{pplndCd}
	</update>
	
	<!-- 상세 생산계획 삭제 -->
	<delete id="deletePlanDetail" parameterType="com.mandu.yamyam.pro.service.ProVO">
		DELETE FROM P_PLND WHERE PPLND_CD = #{pplndCd}
	</delete>
	
	<!-- 생산계획 삭제 -->
	<delete id="deletePlan" parameterType="com.mandu.yamyam.pro.service.ProVO">
		DELETE FROM P_PLN WHERE PPLN_CD = #{pplnCd}
	</delete>
	
	<!-- 생산계획 상세 개수 -->
	<select id="detailCnt" resultType="Integer">
		SELECT COUNT(*)
		FROM P_PLND
		WHERE PPLN_CD = #{pplnCd}
	</select>
	
	 
	<!-- 생산요청서 -->
	<select id="orderList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT B.OD_CD, 
		       TO_CHAR(B.DE_DATE,'yyyy-MM-dd') AS DE_DATE, 
		       B.PRD_CD, 
		       C.PRD_NM, 
		       B.OD_AMT
		FROM B_OD B JOIN C_PRD C
              		ON B.PRD_CD = C.PRD_CD
	</select>
	
	<!-- 제품목록 조회 -->
	<select id="materialList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT PRD_CD, PRD_NM
		FROM C_PRD
	</select>
	
</mapper>