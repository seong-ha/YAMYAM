<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mandu.yamyam.pro.mapper.ProMapper">

	<!-- 공통코드 : 공정분류 -->
	<select id="getCommP" resultType="com.mandu.yamyam.pro.service.ProVO">
		select commd_cd, commd_nm
		from c_commd
		where comm_cd = #{commCd}
	</select>
	
	<!-- 공통코드 : 에러코드 -->
	<select id="getCommE" resultType="com.mandu.yamyam.pro.service.ProVO">
		select commd_cd, commd_nm
		from c_commd
		where comm_cd = 'ERR-PRO'
	</select>
	
	<!-- 입력될 생산 우선순위 조회 -->
	<select id="getPrioNo" resultType="Integer">
		SELECT NVL(MAX(PPLND_PRIO),0)+1 as PPLND_PRIO FROM P_PLND
	</select>
	
	<!-- 생산계획조회 -->
	<select id="getPlan" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT TO_CHAR(l.ppln_date,'yyyy-MM-dd') AS ppln_date, 
		       l.ppln_cd, 
		       l.od_cd, 
		       l.ppln_name, 
		       d.pplnd_sts
		from p_pln l 
		join p_plnd d 
		  on l.ppln_cd = d.ppln_cd
		<where>
            <if test='startDate!= null and endDate != null'>
               TRUNC(l.PPLN_DATE) BETWEEN #{startDate}
                      AND #{endDate}
            </if>
        </where>
         ORDER BY PPLN_CD DESC
	</select>
	
	
	<!-- 상세생산계획조회 -->
	<select id="getPlanDetail" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT P.PPLN_CD, P.PPLN_NAME, D.PPLND_CD, D.PRD_CD, D.PPLND_AMT, D.PPLND_PRIO, D.PPLND_DAYS, D.PPLND_STS, C.PRD_NM
		FROM P_PLN P JOIN P_PLND D
             		 ON P.PPLN_CD = D.PPLN_CD
             		 JOIN C_PRD C
             		 ON C.PRD_CD = D.PRD_CD
		WHERE P.PPLN_CD = #{pplnCd}            		 
		<where>
            <if test='startDate!= null and endDate != null'>
               TRUNC(P.PPLN_DATE) BETWEEN #{startDate}
                      AND #{endDate}
            </if>
        </where>
        ORDER BY P.PPLN_CD, D.PPLND_CD
        
	</select>
	
	
	<!-- 생산계획 등록 -->
	<insert id="insertPlan" parameterType="com.mandu.yamyam.pro.service.ProVO">
		<selectKey keyProperty="pplnCd" resultType="String" order="BEFORE">
			select mk_ppln_cd from dual
		</selectKey>
		insert into p_pln(
							<if test="pplnDate != null">
							ppln_date,
					 		</if>							
							ppln_cd,
							od_cd,
							ppln_name
							)
		
					values(
							<if test="pplnDate != null">
							#{pplnDate},
					 		</if>
							#{pplnCd},
							#{odCd},
							#{pplnName}
						   )
	</insert>
	
	
	<!-- 상세생산계획 등록 -->
	<insert id="insertPlanDetail" parameterType="com.mandu.yamyam.pro.service.ProVO">
		<selectKey keyProperty="pplndCd" resultType="String" order="BEFORE">
			select mk_pplnd_cd from dual
		</selectKey>
		insert into p_plnd(
							pplnd_cd,
							ppln_cd,
							ppln_date,
							pplnd_prio,
							pplnd_days,
							prd_cd,
							pplnd_amt

							)
		
					values(
							#{pplndCd},
							#{pplnCd},
							#{pplnDate},
							#{pplndPrio},
							#{pplndDays},
							#{prdCd},
							#{pplndAmt}
						   )
	</insert>
	
	<!-- 생산요청서 진행사항 수정 -->
	<update id="updateBpod" parameterType="com.mandu.yamyam.pro.service.ProVO">
		update b_pod set rqt_sts = 'RQT-STS3'
		where od_cd = #{odCd}
	</update>
	
	<!-- 생산계획 우선순위, 생산일자 수정 -->
	<update id="updatePlanDetail" parameterType="com.mandu.yamyam.pro.service.ProVO">
		UPDATE P_PLND
		   <set>
		   		<if test="pplndPrio != null">
		   			PPLND_PRIO = #{pplndPrio},
		   		</if>
		   		<if test="pplndDays != null">
		   			PPLND_DAYS = #{pplndDays}
		   		</if>
		   </set>
		 WHERE PPLND_CD = #{pplndCd}
	</update>
	
	<!-- 상세 생산계획 삭제 -->
	<delete id="deletePlanDetail" parameterType="com.mandu.yamyam.pro.service.ProVO">
		DELETE FROM P_PLND WHERE PPLND_CD = #{pplndCd}
	</delete>
	
	<!-- 생산계획 삭제 -->
	<delete id="deletePlan" parameterType="com.mandu.yamyam.pro.service.ProVO">
		DELETE FROM P_PLN WHERE PPLN_CD = #{pplnCd}
	</delete>
	
	<!-- 생산계획 상세 개수 -->
	<select id="detailCnt" resultType="Integer">
		SELECT COUNT(*)
		FROM P_PLND
		WHERE PPLN_CD = #{pplnCd}
	</select>
	
	 
	<!-- 생산요청서 -->
	<select id="orderList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		select p.od_cd, p.prd_cd, c.prd_nm ,p.rqt_amt, TO_CHAR(b.de_date,'yyyy-MM-dd') as de_date
		from b_pod p join b_od b on p.od_cd = b.od_cd
             join c_prd c on  c.prd_cd = b.prd_cd
		where p.rqt_sts = '미계획'
	</select>
	
	<!-- 제품목록 조회 -->
	<select id="materialList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT PRD_CD, PRD_NM
		FROM C_PRD
	</select>
	
	<!-- 미지시계획 조회 -->
	<select id="noOrderList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT TO_CHAR(d.ppln_date,'yyyy-MM-dd') as ppln_date, d.pplnd_cd, p.ppln_cd, p.ppln_name, d.pplnd_cd, c.prd_nm, d.pplnd_amt,d.pplnd_days, c.prd_cd
		FROM p_pln p JOIN p_plnd d ON p.ppln_cd = d.ppln_cd
                     JOIN c_prd c ON c.prd_cd = d.prd_cd
		<where>
            <if test='startDate!= null and endDate != null'>
               TRUNC(d.ppln_date) BETWEEN #{startDate} AND #{endDate} AND
            </if>
            d.pplnd_sts='미지시'
        </where>
	</select>
	
	<!-- 생산라인 조회 -->
	<select id="lineList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		select p.pplnd_cd, l.pline_cd, p.prd_cd from p_plnd p join p_line l on p.prd_cd = l.prd_cd 
		where p.PRD_CD = #{prdCd} 
		and ROWNUM &lt;= #{pplndDays}
	</select>
	
	
	<!-- 생산지시 등록 -->
	<insert id="insertOrder" parameterType="com.mandu.yamyam.pro.service.ProVO">
		<selectKey keyProperty="podCd" resultType="String" order="BEFORE">
			SELECT mk_pod_cd FROM DUAL
		</selectKey>
		INSERT INTO p_od (
						  pod_cd,
						  pplnd_cd,
						  prd_cd,
						  pline_cd
						  )
			   VALUES(
			   		   #{podCd},
			   		   #{pplndCd},
			   		   #{prdCd},
			   		   (SELECT PLINE_CD FROM P_LINE WHERE PRD_CD = #{prdCd}))
		
	</insert>
	
	
	<!-- 상세 생산지시 등록 -->
	<insert id="insertOrderDetail" parameterType="com.mandu.yamyam.pro.service.ProVO">
		<selectKey keyProperty="poddCd" resultType="String" order="BEFORE">
			SELECT mk_podd_cd FROM DUAL
		</selectKey>
		INSERT INTO P_ODD(
							PODD_CD,
							POD_CD,
							PODD_AMT,
							PODD_DATES,
							PODD_PRIO
						  )
				VALUES(#{poddCd},
					   #{podCd},
					   #{poddAmt},
					   #{poddDates},
					   #{poddPrio})
	</insert>
	
	<!-- 생산지시 조회 -->
	<select id="getOrderList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		select o.pod_cd, od.podd_cd,c.prd_nm, o.prd_cd, od.podd_amt, o.pline_cd, od.podd_prio, od.podd_sts,
		      TO_CHAR(od.podd_dates,'yyyy-MM-dd') as podd_dates
		from p_od o join p_odd od on o.pod_cd= od.pod_cd
	            	join c_prd c on o.prd_cd = c.prd_cd
	    <where>
	        <if test='startDate!= null and endDate != null'>
	               TRUNC(od.podd_dates) BETWEEN #{startDate} AND #{endDate}
	        </if>
        </where>
		order by 1,2,7             	
	</select>
	
	
	<!-- 상세 생산계획 테이블 진행구분 업데이트(미지시 -> 지시완료)-->
	<update id="updatePplnd" parameterType="com.mandu.yamyam.pro.service.ProVO">
		UPDATE p_plnd SET PPLND_STS = '지시완료' where pplnd_cd = (select pplnd_cd from p_od WHERE POD_CD = #{podCd})
	</update>
	
	
	<!-- 생산관리 : 생산지시 목록 조회 -->
	<select id="getOProList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT p.pline_cd,c.prd_nm,TO_CHAR(d.podd_dates,'yyyy-MM-dd') AS podd_dates, d.podd_cd, p.prd_cd, d.podd_amt
		FROM p_od p JOIN p_odd d ON d.pod_cd = p.pod_cd
					JOIN c_prd c ON p.prd_cd = c.prd_cd
		WHERE  TRUNC(SYSDATE) = TRUNC(d.podd_dates)
		ORDER BY 3
	</select>
	
	<!-- 생산관리 : 공정목록 조회 -->
	<select id="flowProgress" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT p.ppro_cd, p.ppro_name, e.eqp_cd,e.eqp_nm, find_code_name(e.eqp_sts) AS eqp_sts , p.ppro_emp_name, p.pline_cd
		FROM p_pro p JOIN e_eqp e ON p.eqp_cd = e.eqp_cd
		WHERE p.pline_cd = #{plineCd}
	</select>
	
	<!-- 설비상태 수정 -->
	<update id="updateEqpSts" parameterType="com.mandu.yamyam.pro.service.ProVO">
		UPDATE e_eqp SET eqp_sts =
		CASE 
		    WHEN eqp_sts = 'EQP-STS1' THEN 'EQP-STS3'
		    WHEN eqp_sts = 'EQP-STS3' THEN 'EQP-STS1'
		    ELSE 'EQP-STS3'
		END
		WHERE eqp_cd = #{eqpCd}
	</update>
	
	<!-- 생산관리 : 진행 후 조회 -->
	<select id="afterProgress" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT p.ppro_cd, p.ppro_name, e.eqp_cd,e.eqp_nm, find_code_name(e.eqp_sts) AS eqp_sts , p.ppro_emp_name,
			   p.ppro_er_amt,p.ppro_ot_amt, p.ppro_in_amt, p.pline_cd,
			   TO_CHAR(p.ppro_s_time, 'yyyy-MM-dd HH24:MM:SS') as ppro_s_time,
               TO_CHAR(p.ppro_e_time, 'yyyy-MM-dd HH24:MM:SS') as ppro_e_time 
		FROM p_pro p JOIN e_eqp e ON p.eqp_cd = e.eqp_cd
        WHERE p.pline_cd = #{plineCd}
	</select>
	
	<!-- 입고수량 수정 -->
	<update id="updateProInAmt"  parameterType="com.mandu.yamyam.pro.service.ProVO">
		UPDATE p_pro
		 <set>
		   		<if test="pproInAmt != null">
		   			ppro_in_amt = #{pproInAmt},
		   		</if>
		   		<if test="pproErAmt != null">
		   			ppro_er_amt = #{pproErAmt},
		   		</if>
		   		<if test="pproOtAmt != null">
		   			ppro_ot_amt = #{pproOtAmt},
		   		</if>
		   		<if test="pproSTime != null and !pproSTime.equals('')">
		   			ppro_s_time = #{pproSTime},
		   		</if>
		   		<if test="pproETime != null and !pproETime.equals('')">
		   			ppro_e_time = #{pproETime}
		   		</if>
		   </set>
		WHERE ppro_cd= #{pproCd}
	</update>
	
	<!-- 공정 실적 조회 -->
	<select id="getResultList" resultType="com.mandu.yamyam.common.LowerKeyMap">
	   SELECT p.ppro_cd, p.ppro_name, e.eqp_cd,e.eqp_nm, find_code_name(e.eqp_sts) AS eqp_sts,
	   	      p.ppro_emp_name, TO_CHAR(p.ppro_s_time, 'yyyy-MM-dd HH24:MM:SS') as ppro_s_time,
       TO_CHAR(p.ppro_e_time, 'yyyy-MM-dd HH24:MM:SS') as ppro_e_time, p.ppro_er_amt,p.ppro_ot_amt, p.ppro_in_amt, p.pline_cd,
       d.pod_cd, TO_CHAR(d.pod_dates, 'yyyy-MM-dd') as pod_dates
	   FROM p_pro p JOIN e_eqp e ON p.eqp_cd = e.eqp_cd
             JOIN p_line l ON l.pline_cd = p.pline_cd
             JOIN p_od d ON l.pline_cd = d.pline_cd
	</select>
	
	<!-- 공정관리 조회 -->
	<select id="getProList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT p.ppro_sts, p.ppro_cd, p.ppro_name, p.eqp_cd, p.ppro_emp_name, e.eqp_nm, e.md_nm
		FROM p_pro p JOIN e_eqp e ON p.eqp_cd = e.eqp_cd
		<where>
			<if test="eqpType != null and !eqpType.equals('')">
				e.eqp_type = #{eqpType}
			</if>
		</where>
	</select>
	
	<!-- 제품 공정 흐름도 조회 -->
	<select id="getFlowList" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT p.pline_cd, p.prd_cd, c.prd_nm FROM p_line p JOIN c_prd c ON p.prd_cd = c.prd_cd
	</select>
	
	<!-- 제품 공정 흐름도 관리 -->
	<select id="flowManage" resultType="com.mandu.yamyam.common.LowerKeyMap">
		SELECT p.ppro_cd, p.ppro_name, e.eqp_cd, e.eqp_nm FROM p_pro p JOIN e_eqp e ON p.eqp_cd=e.eqp_cd WHERE p.pline_cd=#{plineCd}
	</select>
	
	<!-- 미사용 설비 조회 -->
	<select id="noUseEqp" resultType="com.mandu.yamyam.pro.service.ProVO">
		SELECT * FROM e_eqp WHERE eqp_sts='EQP-STS2'
	</select>
</mapper>