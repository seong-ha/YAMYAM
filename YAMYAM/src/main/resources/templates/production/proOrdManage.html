<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">

<head>
<meta charset="UTF-8">
<title>YAMYAM</title>
<style>
.btn2 {
	padding : 10px;
	margin : 5px;
	width : 90px;
}
.row {
	margin-bottom : 20px;
	margin-top : 30px;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/dayjs.min.js"></script>
</head>

<body>
	<!-- 본문 시작 -->
	<div layout:fragment="content" class="container">
		<div><button type="button" id="scheduleBtn" class="btn btn-dark btn-sm" style="float: right">공정이동표</button></div>
		<h3>생산 관리</h3>
		
	<div class="row">
		<h4>진행생산지시</h4>
		<div id="pOrderGrid"></div>
	</div>
	<div class="row">
			<h4>공정목록</h4>
			<div id="proGrid"></div>
			<div>
				<button type="button" id="restartBtn" class="btn btn-dark btn2" style="float:right;">재시작</button>
				<button type="button" id="stopBtn" class="btn btn-dark btn2" style="float:right;">긴급중지</button>
				<button type="button" id="startBtn" class="btn btn-dark btn2" style="float:right;">생산시작</button>
			</div>
		
	</div>
	

	
	<!-- 공정이동표 모달 -->
	<div class="modal" id="progressModal" tabindex="-1">
		<div class="modal-dialog modal-xl" >
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">공정이동표</h4>
					<button type="button" class="btn-close" data-bs-dismiss="modal"	aria-label="Close" id="close_modal"></button>
				</div>
				<div class="modal-body">
					<div>
						<table style="margin:auto;">
							<tr>
								<td>라인코드 : </td>
								<td><input type="text" id="linCd" readonly="readonly"></td>
								<td>제품코드 : </td>
								<td><input type="text" id="prCd" readonly="readonly"></td>
							</tr>
							<tr>
								<td>제품명 : </td>
								<td><input type="text" id="prNm" readonly="readonly"></td>
								<td>수량 : </td>
								<td><input type="number" id="iAmt" readonly="readonly"></td>
							</tr>
						</table>
					</div>
					<div id="pLModalGrid"></div>
					
				</div>
			</div>
		</div>
	</div>
		
<script>

	let pOrderGrid = orderGridInit();			// 진행생산지시 grid 초기화
	let proGrid = progressGridInit();		// 공정목록 grid 초기화
	let pLModalGrid = pLModalGridInit();		// 공정이동표 모달 grid
	
	
	startBtnHandler();  		// 시작 버튼 이벤트 핸들러
	stopBtnHandler();			// 중지 버튼 이벤트 핸들러
	restartBtnHandler();		// 재시작 버튼 이벤트 핸들러
	scheduleBtnHandler();		// 공정이동표 클릭 버튼 이벤트 핸들러
	pOrderGridClickHandler();   // 진행생산지시 그리드 클릭 버튼 이벤트 핸들러

	
	/*------------
	// 진행생산지시 grid
	----------------*/
	
	function orderGridInit(){
		let pOrderGrid = new tui.Grid({
			el: document.getElementById('pOrderGrid'),
			scrollX: false,
			scrollY: false,
			rowHeaders: ['rowNum'],
			columns: [
				{
					header: '생산지시코드',
					name: 'poddCd'
				},
				{
					header: '제품코드',
					name: 'prdCd'
				},
				{
					header: '제품명',
					name: 'prdNm'
				},
				{
					header: '수량',
					name: 'poddAmt' 
				},
				{
					header: '라인코드',
					name: 'plineCd'
				}
			]
		});
		
		$.ajax({
			url : '/getOProList',
			method: "GET",			
		}).then(res=>{
			pOrderGrid.resetData(res);
		})
		
		return pOrderGrid;
	}
	
	
	
	
	/*------------
	// 공정목록 grid
	----------------*/
	
	function progressGridInit(){
		let proGrid = new tui.Grid({
			el: document.getElementById('proGrid'),
			scrollX: false,
			scrollY: false,
			rowHeaders: ['rowNum'],
			columns: [
				{
					header: '공정코드',
					name: 'pproCd'
				},
				{
					header: '공정명',
					name: 'pproName'
				},
				{
					header: '설비코드',
					name: 'eqpCd'
				},
				{
					header: '설비명',
					name: 'eqpNm'
				},
				{
					header: '담당자',
					name: 'pproEmpName'
				},
				{
					header: '투입량',
					name: 'pproInAmt',
					width : '100'
				},
				{
					header: '불량량',
					name: 'pproErAmt',
					width : '100'
				},
				{
					header: '생산량',
					name: 'pproOtAmt',
					width : '100'
				},
				{
					header: '시작시간',
					name: 'pproSTime'
				},
				{
					header: '종료시간',
					name: 'pproETime'
				},
				{
					header: '상태', // 설비상태
					name: 'eqpSts',
					width : '20'
				},
			]
		});
		return proGrid;
	}
	
	
	
	
	
	/*------------
	// 공정이동표 모달 grid
	----------------*/
	
	function pLModalGridInit(){
		let pLModalGrid = new tui.Grid({
			el: document.getElementById('pLModalGrid'),
			scrollX: false,
			scrollY: false,
			rowHeaders: ['rowNum'],
			columns: [
				{
					header: '공정코드',
					name: 'pproCd'
				},
				{
					header: '공정명',
					name: 'pproName'
				},
				{
					header: '설비코드',
					name: 'eqpCd'
				},
				{
					header: '설비명',
					name: 'plineCd'
				},
				{
					header: '담당자',
					name: 'pproEmpName'
				},
				{
					header: '투입량',
					name: 'pproInAmt'
				},
				{
					header: '불량량',
					name: 'pproErAmt'
				},
				{
					header: '생산량',
					name: 'pproOtAmt'
				}
			]
		});
	
		return pLModalGrid;
	}
	
	
	
	/*------------
	// 진행생산지시 그리드 클릭 버튼 이벤트 핸들러
	----------------*/
	function pOrderGridClickHandler(){
		$('#pOrderGrid').on('click',function(ev){
			let data = pOrderGrid.getData();
			let plineCd = data[0].plineCd;
			let pproInAmt = data[0].poddAmt;
			$.ajax({
				url : '/flowProgress',
				data : {"plineCd" : plineCd},
				contentType: 'application/json',
				dataType : 'json',
				method: "GET",
				success : function(data){
					proGrid.resetData(data);
					proGrid.setValue(0,'pproInAmt',pproInAmt);
				},
				error : function(reject){console.log(reject);}				
			})
			
		})
	}
	


	
	/*------------
	// sweetConfirm 
	----------------*/
	function sweetConfirm(msg, ic, callBack){
		let msgA = {'S':'시작', 'T':'중지', 'R':'재시작'}

		 Swal.fire({
		      title: `${msgA[msg]} 하시겠습니까?`,
		      icon: ic,
		      showCancelButton: true,
		      confirmButtonColor: '#3085d6',
		      cancelButtonColor: '#d33',
		      confirmButtonText: '승인',
		      cancelButtonText: '취소'
		      
		    }).then((result) => {
		    if(result.isConfirmed){
		     	callBack();
		    }
		     
		     })
		     
	}
	
		
	
	
	
	/*------------
	// 공정표 클릭 버튼 이벤트 핸들러
	----------------*/
	function scheduleBtnHandler(){
		// 모달 클릭 버튼 이벤트
		$('#scheduleBtn').on('click',function(){
	
			 $("#progressModal").modal("show");
				let rKey = pOrderGrid.getFocusedCell().rowKey;
				let data = pOrderGrid.getRow(rKey);
				
				let prcd = data.prdCd;
				let plineCd = data.plineCd;
				let prNm = data.prdNm;
				let iAmt = data.poddAmt;
				$('#linCd').val(plineCd);
				$('#prCd').val(prcd);
				$('#prNm').val(prNm);
				$('#iAmt').val(iAmt);
				$.ajax({
					url : '/afterProgress',
					data : {"plineCd" : plineCd},
					contentType: 'application/json',
					dataType : 'json',
					method: "GET",
					success : function(data){
						pLModalGrid.resetData(data);
						
					},
					error : function(reject){console.log(reject);}				
				});

			// 모달이 로드 되는데 시간이 걸리므로 인터벌 걸어주기
			setInterval(function(){
				pLModalGrid.refreshLayout()
				},100);	
		});
	}
	
	
	/*------------
	// 재시작 버튼 이벤트 핸들러
	----------------*/
	function restartBtnHandler(){
		
		$('#restartBtn').on('click',function(){
			// sweetalert2
			sweetConfirm('R', 'info', function(){
				let eqpSts = proGrid.getValue(0,'eqpSts');
				let data = proGrid.getData();
				
				if(eqpSts == '긴급중지'){
					for(let i=0; i<data.length; i++){
						proGrid.setValue(i,'eqpSts','대기');	
					}
				}
				//변수 = setInterval(콜백함수, 시간);
				interval = setInterval(sweetC,1000); 
				
			})
		})
	}
	
	/*------------
	// 시작 버튼 이벤트 핸들러
	----------------*/
	function startBtnHandler(){
		$('#startBtn').on('click',function(){
			// sweetalert2
			sweetConfirm('S', 'success', sweetC);
		})
	}
	
	
	var n = 0;
	var interval;
	function sweetC(){
	
		// 첫번째 설비 시작
		startEqp(n,getTimeStr());
		interval = setInterval(viewProgress,1000);  // 변수를 선언해줄경우 1번 실행
		setTimeout(()=>{Swal.fire('완료되었습니다');},6000);
	
		function viewProgress(){
			
			// 설비상태 : 가동으로 업데이트 ajax : update
			// 설비 가동 -> 시작시간
			let time = getTimeStr();
			stopEqp(n,time)
			n++;
			
			if(n>=6){	// 공정이 끝나면 interval끝
				clearInterval(interval);
				
				let pro = proGrid.getData();
				for(let i =0; pro.length; i++){
					proGrid.setValue(i,'eqpSts','완료');
				}
				
				let binAmt = pro[5].pproOtAmt;
				let pG = pOrderGrid.getFocusedCell().rowKey;
				let poddCd = pOrderGrid.getValue(pG,'poddCd');
				let prdCd = pOrderGrid.getValue(pG,'prdCd');
				console.log(binAmt);
				// ajax (b-in[완제품재고] table insert)

				$.ajax({
					url : '/insertBIn',
					method: 'POST',
					data :  {"binAmt" : binAmt, "samt" : binAmt, "prdCd" : prdCd, "poddCd": poddCd},
					dataType : 'json',
					success : function(data){
							console.log(data);
							},
					error : function(reject){
							console.log(reject);
							// 실패
					}			 		  
				});

			}
			
			startEqp(n,time);
			
		}
		
		
		// 설비 시작
		function startEqp(n,time){
			// 처음이면
			let pG = pOrderGrid.getFocusedCell().rowKey;
	
			let pproInAmt;
			if(n==0){
				pproInAmt = pOrderGrid.getValue(pG,'poddAmt');
				
			}else {
				pproInAmt = proGrid.getValue(n-1,'pproOtAmt');
			}
			// 중지 -> 다음꺼 시작
			
			let pproSTime = time;
			
			let eqpCd = proGrid.getValue(n,'eqpCd');
			let plineCd = proGrid.getValue(n,'plineCd');
			let pproCd = proGrid.getValue(n,'pproCd');	
			let eqpSts = proGrid.getValue(n,'eqpSts'); // 0번째 설비 상태 (현재 가동중)
		 
			if(eqpSts == '대기'){
				// 대기 -> 가동
				 $.ajax({
					url : '/eqpUpdate',
					method: 'POST',
					async : false,
					data :  {"eqpCd" : eqpCd, "plineCd" : plineCd, "pproCd" : pproCd, "pproInAmt": pproInAmt, "pproSTime" : pproSTime},
					dataType : 'json',
					success : function(data){
							// grid에서 수정
							proGrid.resetData(data);
							proGrid.refreshLayout();
							},
					error : function(reject){
							console.log(reject);
							// 실패
					}			 		  
				});
			}
		}
		
		// 설비 중지
		function stopEqp(n,time){
			let eqpCd = proGrid.getValue(n,'eqpCd');
			let plineCd = proGrid.getValue(n,'plineCd');
			let eqpSts = proGrid.getValue(n,'eqpSts');
			let pproCd = proGrid.getValue(n,'pproCd');
			let pproInAmt = proGrid.getValue(n,'pproInAmt');
			
			let pproETime = time;
			let pproErAmt = 0;	
			let pproOtAmt = pproInAmt - pproErAmt; 
			
			if(eqpSts == "가동"){
				// 설비상태 업데이트
				$.ajax({
					url : '/eqpUpdate',
					method: 'POST',
					data : {"eqpCd" : eqpCd, "plineCd" : plineCd, "pproETime" : pproETime, "pproCd" : pproCd, "pproErAmt" : pproErAmt, "pproOtAmt" : pproOtAmt},
					dataType : 'json',
					async : false,
					success : function(data){
							// grid에서 수정
							proGrid.resetData(data);
							proGrid.refreshLayout();
							},
					error : function(reject){
							console.log(reject);
							// 실패
					}			 		  
				});	// end of ajax 
			}

		} 
		
		
	}

	/*------------
	// 긴급중지 버튼 이벤트 핸들러
	----------------*/
	function stopBtnHandler(){
	
		$('#stopBtn').on('click',function(){
			// sweetalert2
			sweetConfirm('T', 'error', function(){
				clearInterval(interval);
				
				let data = proGrid.getData();
				for(let i = 0; i< data.length; i++){
					let eqpSts = data[i].eqpSts;
					if(eqpSts == "가동"){
					let eqpCd = data[i].eqpCd;
					let plineCd = data[i].plineCd;
					proGrid.setValue(i,'eqpSts','긴급중지');
					// 설비상태 업데이트
					$.ajax({
						url : '/eqpUpdate',
						method: 'POST',
						data : {"eqpCd" : eqpCd, "plineCd" : plineCd},
						dataType : 'json',
						success : function(data){
								// grid에서 수정
								proGrid.resetData(data);
								for(let i=0; i<data.length; i++){
									proGrid.setValue(i,'eqpSts','긴급중지');	
								}
								proGrid.refreshLayout();
								},
						error : function(reject){
								console.log(reject);
								// 실패
						}			 		  
					});	// end of ajax
				}	 
					
				}
				
				
				
			})
			
		})
	}
	
	
	

	
</script>		
</div>
</body>
</html>