<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">

<head>
<meta charset="UTF-8">
<title>YAMYAM</title>
<style type="text/css">
.modal-header{
text-align: center;
}
</style>
</head>

<body>
	<div layout:fragment="content" class="container">
		<div class="row">
			<h3>생산지시 관리</h3>
			&nbsp;&nbsp;
			<button type="button" id="showNOModal" class="btn btn-dark btn-sm"
				style="width: 140px" data-bs-toggle="modal"
				data-bs-target="#noOrderModal">미지시 계획 조회</button>
		</div>
		<div class="row">
			<div class="col-6">
				상세생산계획
				<div id="planDGrid"></div>
			</div>
			<div class="col-6">
				생산지시
				<div id="planOrder"></div>
			</div>
		</div>
		<div class="row">
			<div class="col-6">
				필요자재
				<!-- 필요자재 모달버튼 -->
				<button type="button" id="mLModalBtn" hidden class="btn btn-dark btn-sm"
					data-bs-toggle="modal" data-bs-target="#matLotModal">필요자재
					모달 조회</button>
				<div id="matNeed"></div>
				<p style="font-size: 0.5em">소모량 : 자재별 필요량*작업수량</p>
			</div>
			<div class="col-6">
				필요자재LOT

				<div id="matLot"></div>
				<button type="button" id="deleteBtn"
				class="btn btn-dark btn-sm" >행 삭제</button>
				
			</div>
		</div>

		<!-- 필요자재LOT 모달 -->
		<div class="modal" id="matLotModal" tabindex="-1"
			aria-labelledby="matLotModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title" id="matLotModalLabel">필요자재LOT 목록</h4>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div>
							<div>
								<label for="name">자재명: </label>
								<input type="text" id="name" name="name" value="부추" style="width: 120px">
								
								<label for="amt">필요수량: </label>
								<input type="number" id="amt" name="amt" style="width: 120px" value="200">
								<button type="button" class="btn btn-dark btn-sm">조회</button>
							</div>

							<div id="matLotGrid2"></div>

						</div>
					</div>

				</div>
			</div>
		</div>
		
		<!-- 미지시 계획 조회 모달 -->
		<div class="modal" id="noOrderModal" tabindex="-1">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title" id="noOrderModalLabel">미지시 생산계획 목록</h4>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div>
							<div id="modalGrid"></div>
						</div>
					</div>

				</div>
			</div>
		</div>
		
		
		<script>
		// 그리드 초기화
		let planDGrid = planDGridInit(); 	 // 상세계획 조회 grid
		let planOrder = planOrderGridInit(); // 생산지시 grid 
		let matNeed = matNeedGridInit();	 // 필요자재 grid 
		let matLot = matLotGridInit(); 		 // 필요자재 LOT grid 
		let matLotGrid2 = matLotGrid2Init(); // 모달에 뜨는 필요자재 LOT grid 
		let modalGrid =  modalGridInit(); // 모달에 뜨는 생산요청 toast grid 
		
		
		// 이벤트 핸들러 호출
		deleteBtnHandler(); 	 // 필요자재 LOT grid 선택 행 삭제
		showNOModalHandler(); 	 // 미지시계획 모달 클릭 버튼 이벤트
		modalGridClickHandler(); // 미지시계획조회 모달창의 그리드 선택시 자료를 상세생산계획 Grid에 넣어주기
		
		
		
		
		/*------------
		// 상세계획 조회 grid
		----------------*/
	
		function planDGridInit(){
			let planDGrid = new tui.Grid({
				el: document.getElementById('planDGrid'),
				// 임시 데이터
				data: [{
					
					planCode: '',
					productName: '',
					amt: '',
					productAmt: '',
					restAmt: ''
				}],
				// data 가져오는 법
				// data: {
				// 	api: {
				// 		readData: {
				// 			url: '/api/readData',
				// 			method: 'GET'
				// 		}
				// 	}
				// },
				scrollX: false,
				scrollY: false,
				rowHeaders: ['rowNum'],
				// columnOptions: {
				// 	minWidth: 180
				// },
				columns: [
					{
						header: '생산계획코드',
						name: 'planCode'
					},
					{
						header: '제품명',
						name: 'productName'
					},
					{
						header: '수량',
						name: 'amt'
					},
					{
						header: '생산지시량',
						name: 'productAmt'
					},
					{
						header: '잔량',
						name: 'restAmt'
					}
				]
			});
			return planDGrid;
		}
		
		/*------------
		// 생산지시 grid 
		----------------*/
		function planOrderGridInit(){
			let planOrder = new tui.Grid({
				el: document.getElementById('planOrder'),
				// 임시 데이터
				data: [{
					lineCode: 'LIN-BAR-001',
					dates: '20221202',
					amt: '200',
					prio: '1',
					planAmt: '300'
				}],
				// data 가져오는 법
				// data: {
				// 	api: {
				// 		readData: {
				// 			url: '/api/readData',
				// 			method: 'GET'
				// 		}
				// 	}
				// },
				scrollX: false,
				scrollY: false,
				rowHeaders: ['rowNum'],
				columns: [
					{
						header: '라인코드',
						name: 'lineCode',
					},
					{
						header: '작업일자',
						name: 'dates'
					},
					{
						header: '작업수량(BOX)',
						name: 'amt'
					},
					{
						header: '일자별우선순위',
						name: 'prio'
					},
					{
						header: '비고',
						name: 'other'
					}
				]
			});
			return planOrder;
		}
		
		
		/*------------
		// 필요자재 grid  
		----------------*/
		function matNeedGridInit(){
			let matNeed = new tui.Grid({
				el: document.getElementById('matNeed'),
				// 임시 데이터
				data: [
					{
				
					prdCd: 'MD-00200',
					mtrCd: 'RML-10101',
					name: '얇은 만두피',
					amt : '200'	},
					{
					
					prdCd: 'MD-00200',
					mtrCd: 'RML-10201',
					name: '부추',
					amt : '300'	},
					{
					
					prdCd: 'MD-00200',
					mtrCd: 'RML-10301',
					name: '다진고기',
					amt : '400'	},
				{
					
					prdCd: 'MD-00200',
					mtrCd: 'RML-10401',
					name: '두부',
					amt : '500'	}
				],
				// data 가져오는 법
				// data: {
				// 	api: {
				// 		readData: {
				// 			url: '/api/readData',
				// 			method: 'GET'
				// 		}
				// 	}
				// },
				scrollX: false,
				scrollY: false,
				rowHeaders: ['rowNum'],
				// columnOptions: {
				// 	minWidth: 180
				// },
				columns: [
					{
						header: '제품코드',
						name: 'prdCd',
					},
					{
						header: '자재코드',
						name: 'mtrCd'
					},
					{
						header: '자재명',
						name: 'name'
					},
					{
						header: '소모량',
						name: 'amt'
					}
				]
			});
			
			matNeed.on('click', function(ev){
				//console.log(ev.rowKey); 선택한 행의 row번호
				// 클릭한 행의 자재명, 자재코드 
	
				let mName = matNeed.getRow(ev.rowKey).name;
				let mtrCd = matNeed.getRow(ev.rowKey).mtrCd;
				console.log(mName,mtrCd)
				$("#matLotModal").modal("show");
				
				// 모달이 로드 되는데 시간이 걸리므로 인터벌 걸어주기
				setInterval(function(){
					matLotGrid2.refreshLayout()
					},100);			
			})
		}
		

		
		
		
		/*------------
		// 필요자재 LOT grid 
		----------------*/
		
		function matLotGridInit(){
			let matLot = new tui.Grid({
				el: document.getElementById('matLot'),
				// 임시 데이터
				data: [{
					
					name: '얇은 만두피',
					mLot : 'RML-10000-220122001',
					amt : '200'	,
					eDate : '2022/11/15',
					poddCd: 'RML-10101'},
					{	
						name: '부추',
						mLot : 'RML-10000-220122002',
						amt : '300'	,
						eDate : '2022/11/17',
						poddCd: 'RML-10101'},
					{
						
						name: '다진고기',
						mLot : 'RML-10000-220122003',
						amt : '400'	,
						eDate : '2022/11/16',
						poddCd: 'RML-10101'},
					{
						
						name: '두부',
						mLot : 'RML-10000-220122004',
						amt : '500'	,
						eDate : '2022/11/14',
						poddCd: 'RML-10101'}
					],
				// data 가져오는 법
				// data: {
				// 	api: {
				// 		readData: {
				// 			url: '/api/readData',
				// 			method: 'GET'
				// 		}
				// 	}
				// },
				scrollX: false,
				scrollY: false,
				rowHeaders: ['checkbox', 'rowNum'],
				// columnOptions: {
				// 	minWidth: 180
				// },
				columns: [
					{
						header: '자재명',
						name: 'name',
					},
					{
						header: '자재LOT번호',
						name: 'mLot'
					},
					{
						header: '사용수량',
						name: 'amt'
					},
					{
						header: '유통기한',
						name: 'eDate'
					},
					{
						header: '지시디테일코드',
						name: 'poddCd'
					},
					
				]
			});
			return matLot;
		}
			
		
		
		
		/*------------
		// 모달에 뜨는 필요자재 LOT grid 
		----------------*/	
		function matLotGrid2Init(){
			let matLotGrid2 = new tui.Grid({
				el: document.getElementById('matLotGrid2'),
				// 임시 데이터
				data: [{
						
						mLot : 'RML-10000-220122001',
						sAmt : '12582324200',
						amt : '200'	,
						eDate : '2022/11/15',
						},
						{
					
						mLot : 'RML-10000-220122002',
						sAmt : '12582324200',
						eDate : '2022/11/16',
						},
						{
						
						mLot : 'RML-10000-220122003',
						sAmt : '12582324200',
						eDate : '2022/11/20',
						},
						{
						
						mLot : 'RML-10000-220122004',
						sAmt : '12582324200',
						eDate : '2022/11/17',
						}],
				// data 가져오는 법
				// data: {
				// 	api: {
				// 		readData: {
				// 			url: '/api/readData',
				// 			method: 'GET'
				// 		}
				// 	}
				// },
				scrollX: false,
				scrollY: false,
				rowHeaders: ['checkbox','rowNum'],
				// columnOptions: {
				// 	minWidth: 180
				// },
				columns: [
					{
						header: '자재LOT번호',
						name: 'mLot'
					},
					{
						header: '현재고',
						name: 'sAmt'
					},
					{
						header: '사용수량',
						name: 'amt',
						editor: 'text'
					},
					{
						header: '유통기한',
						name: 'eDate'
					},
				],
				summary: {
			        height: 40,
			        position: 'bottom', // or 'top'
			        columnContent: {
			          amt: {
			            template: function(valueMap) {
			              return `TOTAL: ${valueMap.sum}`;
			            }
			          }
			        }
			      }
			});
			return matLotGrid2; 
		}
		
		
		
		
		
		/*------------
		// 모달에 뜨는 생산요청 toast grid 
		----------------*/	
		function modalGridInit(){
			let modalGrid = new tui.Grid({
				el: document.getElementById('modalGrid'),
				// 임시 데이터
				data: [{
					planCode: 'pro_123456',
					planName: '얇은피 김치만두 200',
					planDCode: 'pro_123456',
					productName: '얇은피 김치만두'
				}],
				// data 가져오는 법
				// data: {
				// 	api: {
				// 		readData: {
				// 			url: '/api/readData',
				// 			method: 'GET'
				// 		}
				// 	}
				// },
				scrollX: false,
				scrollY: false,
				rowHeaders: ['rowNum'],
				columns: [
					{
						header: '계획코드',
						name: 'planCode',
					},
					{
						header: '계획명',
						name: 'planName', //납기일자명 수정
					},
					{
						header: '상세계획코드',
						name: 'planDCode'
					},
					{
						header: '제품명',
						name: 'productName'
					}
				]
			});
			
			return modalGrid;
		}
		
		
		
		/*------------
		// deleteBtn 이벤트 핸들러 
		----------------*/	
		function deleteBtnHandler(){
		// 필요자재 LOT grid 선택 행 삭제
			$('#deleteBtn').on('click',function(){
				// let change = confirm("행을 삭제하시겠습니까?");
				// grid에서 삭제
				
				sweetConfirm('D', function(){
				
					// DB delete
					// ajax 받아오고
					// success : function(data){insertGrid.resetData(data);}
	
					Swal.fire('삭제 완료되었습니다');
					// grid에서 등록
					matLot.removeCheckedRows();
					// 실패
				})
			});
		}
	
		

		/*------------
		// showNOModalBtn 이벤트 핸들러 
		----------------*/	
		function showNOModalHandler(){
			// 미지시계획 모달 클릭 버튼 이벤트
			$('#showNOModal').on('click',function(){
		
				$('#noOrderModal').modal("show");
				modalGrid.refreshLayout();
			});
		}
		
		/*------------
		// modalGrid 클릭 이벤트 핸들러 
		----------------*/	
		function modalGridClickHandler(){
		// 미지시계획조회 모달창의 그리드 선택시 자료를 상세생산계획 Grid에 넣어주기
			modalGrid.on('click',function(ev){
				let plCode = modalGrid.getRow(ev.rowKey).planCode;
				let prName  = modalGrid.getRow(ev.rowKey).productName;
				console.log(plCode+' , '+prName);

				let resetData = [{planCode: plCode, productName: prName,amt: '',productAmt: '',restAmt: ''}];
				planDGrid.resetData(resetData);
				
				/*planDGrid = {planCode: "",productName: "",amt: "",productAmt: "",restAmt: ""} */
				/*modalGrid = {planCode: "",planName: "",productName: ""} */
				//
				/*
				
				let checkCellState = false;
				
				planDGrid.setValue(val, 'planCode' , plCode, checkCellState);
				planDGrid.setValue(val, 'productName' , prName, checkCellState); */
				$('#noOrderModal').modal("hide");
		
			});
		}
		
	</script>

	</div>
	<!-- 본문 끝 -->

</body>

</html>