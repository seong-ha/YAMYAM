<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">

<head>
<meta charset="UTF-8">
<title>YAMYAM</title>
</head>

<body>
	<!-- 본문 시작 -->
	<div layout:fragment="content" class="container">
		<h3>공정 관리</h3>
		<div>
			<table style="width: 100%;">
				<tr>
					<td style="width: 85px;">공정 구분 &nbsp;</td>
				
					<td>
					<select id="pList" name="pList">
					<option th:each="pCode : ${pCode}" th:text="${pCode.commdNm}" th:value="${pCode.commdCd}"></option>			
					</select>
						<button type="button" id="searchBtn" class="btn btn-dark btn-sm">검색</button>
						<button type="button" id="cancelBtn" class="btn btn-dark btn-sm">초기화</button>
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<div id="grid"></div>
					</td>
				</tr>
				<tr>
					<td colspan="3" style="text-align: right;">
						<button type="button" id="plusBtn" class="btn btn-dark btn-sm">행 추가</button>
						<button type="button" id="removeBtn" class="btn btn-dark btn-sm">행 삭제</button>
						<button type="button" id="insertBtn" class="btn btn-dark btn-sm">저장</button>
					</td>
				</tr>
			</table>

		</div>
	<!-- 미사용설비 그리드 모달 -->
	<div class="modal" id="eqModal" tabindex="-1">
		<div class="modal-dialog" >
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">미사용 설비 목록</h4>
					<button type="button" class="btn-close" data-bs-dismiss="modal"	aria-label="Close" id="close_modal"></button>
				</div>
				<div class="modal-body">					
					<div>
						<div id="eqModalGrid"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<script>
		let grid = gridInit();				    // 공정관리 그리드
		let eqModalGrid = eqModalGridInit();	// 미사용 설비 모달 그리드

		
		searchBtnHandler();	 	// 검색 버튼 이벤트 핸들러
		plusBtnHandler(); 	 	// 그리드 행 추가 이벤트 핸들러
		removeBtnHandler();  	// 그리드 행 삭제 이벤트 핸들러
		insertBtnHandler();		// 그리드 행 저장 이벤트 핸들러
		gridClick(); 			// 공정관리 그리드 클릭 이벤트
		eqModalGridClick();		// 미사용 설비 모달  그리드 클릭 이벤트
		cancelBtnHandler();     // 값 초기화 버튼
		
		/*------------
		// grid 초기화
		----------------*/
		function gridInit(){
			let grid = new tui.Grid({
				el : document.getElementById('grid'),
				bodyHeight: 510,
				scrollX : false,
				scrollY : true,
				rowHeaders: ['checkbox','rowNum'],				
				columns : [ 
				{
					header : '공정코드',
					name : 'pproCd',
					editor : 'text'
				}, {
					header : '공정구분',
					name : 'pproSts',
					editor: {
					      type: 'select',
					      options: {
					        listItems: [
					          {text: '혼합', value: '혼합'},
					          {text: '성형', value: '성형'},
					          {text: '증숙', value: '증숙'},
					          {text: '냉동', value: '냉동'},
					          {text: '포장', value: '포장'},
				          	  {text: '박스', value: '박스'}]
					      }
					}
				}, {
					header : '공정명',
					name : 'pproName',
					editor : 'text'
				}, {
					header : '설비명',
					name : 'eqpNm'				
				}, {
					header : '설비코드',
					name : 'eqpCd',
				}, {
					header : '모델명',
					name : 'mdNm',
				}, {
					header : '담당자',
					name : 'pproEmpName',
					editor: {
					      type: 'select',
					      options: {
					        listItems: [
					          {text: '최혼합', value: '최혼합'},
					          {text: '최성형', value: '최성형'},
					          {text: '최증숙', value: '최증숙'},
					          {text: '최냉동', value: '최냉동'},
					          {text: '최포장', value: '최포장'},
				          	  {text: '최박스', value: '최박스'}]
					      }
					}
	
				}]
			});
			
			$.ajax({
				url : '/getProList',
				method: "GET",			
			}).then(res=>{
				grid.resetData(res);
			})
			
			
			return grid;
		}
		
		
		
		/*------------
		// 미사용설비 모달 grid
		----------------*/
		
		function eqModalGridInit(){
			let eqModalGrid = new tui.Grid({
				el: document.getElementById('eqModalGrid'),
				scrollX: false,
				scrollY: false,
				rowHeaders: ['rowNum'],
				columns: [
					{
						header: '설비코드',
						name: 'eqpCd'
					},
					{
						header: '설비명',
						name: 'eqpNm'
					},
					{
						header: '모델명',
						name: 'mdNm'
					},
					{
						header: '관리자',
						name: 'pproEmpName'
					}
				]
			});
			return eqModalGrid;
		}
	
		
		/*------------
		// 공정관리 그리드 클릭 이벤트
		----------------*/
		function gridClick(){
			grid.on('click',function(ev){
				if(!ev.rowKey){
					return;
				}
				let name = grid.getValue(ev.rowKey, 'eqpNm')
				if(name == null){
					$.ajax({
						url : '/noUseEqp',
						method: "GET",			
					}).then(res=>{
						eqModalGrid.resetData(res);
					})
		   			$('#eqModal').modal('show');
		   			eqModalGrid.refreshLayout();
				}
				
			})
		}
	
		/*------------
		// 미설비목록 모달 그리드 클릭 이벤트
		----------------*/
		function eqModalGridClick(){
			eqModalGrid.on('click',function(ev){
				let data = eqModalGrid.getRow(ev.rowKey);

				let eqpCd = data.eqpCd;
				let eqpNm = data.eqpNm;
				let mdNm = data.mdNm;
				let pproEmpName = data.pproEmpName;
				let gRowKey = grid.getFocusedCell().rowKey;
				
				grid.setValue(gRowKey,'eqpCd',eqpCd);
				grid.setValue(gRowKey,'eqpNm',eqpNm);
				grid.setValue(gRowKey,'mdNm',mdNm);
				grid.setValue(gRowKey,'pproEmpName',pproEmpName);
				
				$("#eqModal").modal("hide"); 
			})
		}
		
		/*------------
		// 검색버튼 이벤트 핸들러
		----------------*/
		function searchBtnHandler(){

			$('#searchBtn').on('click',function(){
				let eqpType = $('select[name=pList] option:selected').val();
				
				$.ajax({
					url : '/getProList',
					data : {"eqpType" : eqpType},
					contentType: 'application/json',
					dataType : 'json',
					method: "GET",
					success : function(data){grid.resetData(data);},
					error : function(reject){console.log(reject);}				
				})
			})
		}

		/*------------
		// 초기화버튼 이벤트 핸들러
		----------------*/
		function cancelBtnHandler(){
			$('#cancelBtn').on('click',function(){
				
				$.ajax({
					url : '/getProList',
					contentType: 'application/json',
					dataType : 'json',
					method: "GET",
					success : function(data){grid.resetData(data);},
					error : function(reject){console.log(reject);}				
				})
			});	
		}
		
		/*------------
		// 그리드 행 추가 버튼 이벤트 핸들러
		----------------*/
		function plusBtnHandler(){
			
			$('#plusBtn').on('click',function(){
		
				let rowData = [{pproCd : '',pproSts : '',pproName : '', eqpNm : '',	eqpCd : '',	mdName : '', pproEmpName : ''}]
				grid.appendRow(rowData);
			});

		}
		
		/*------------
		// 삭제 버튼 클릭(그리드행 삭제)
		----------------*/	
		function removeBtnHandler(){
			// grid 선택 행 삭제
			$('#removeBtn').on('click',function(){
				// sweetalert2
				sweetConfirm('D', function(){
					
					// DB delete
					//ajax 
					// 성공

					Swal.fire('삭제가 완료되었습니다');
					// grid에서 삭제
					grid.removeCheckedRows();
					// 실패
				})
				
			});	
		}
		
		
		
		/*------------
		// 저장 버튼 클릭 이벤트 핸들러 (수행시 공정테이블에 insert)
		----------------*/	
		function insertBtnHandler(){
			// grid 선택 행 삭제
			$('#insertBtn').on('click',function(){
				// sweetalert2
				sweetConfirm('C', function(){
					
					// DB delete
					//ajax 
					// 성공

					Swal.fire('저장이 완료되었습니다');
					
					// 실패
				})
				
			});	
		}
	</script>

	</div>

	<!-- 본문 끝 -->

</body>

</html>