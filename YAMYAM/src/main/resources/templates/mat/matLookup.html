<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">

<div class="container" layout:fragment="content">
	<div id="mat-Lookup-title">
		<h3>자재 발주 조회</h3>
	</div>
	<hr>
	<!-- 탭 목록(버튼) 설정 -->
	<ul class="nav nav-tabs nav-pills" id="myTab" role="tablist">
		<li class="nav-item" role="presentation">
			<button class="nav-link active" id="allMat-tab" data-bs-toggle="tab"
				data-bs-target="#allMat" type="button" role="tab"
				aria-controls="allMat" aria-selected="true">자재 전체 조회</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="serchMat-tab" data-bs-toggle="tab"
				data-bs-target="#serchMat" type="button" role="tab"
				aria-controls="serchMat" aria-selected="false">조건 조회</button>
		</li>
	</ul>

	<!-- 탭 본문 시작 -->
	<div class="tab-content" id="myTabContent">
		<div class="tab-pane show active" id="allMat" role="tabpanel"
			aria-labelledby="allMat-tab">
			<div id="grid"></div>
		</div>
		<!-- 조건 조회 탭 -->
		<div class="tab-pane" id="serchMat" role="tabpanel"
			aria-labelledby="serchMat-tab">
			<div><br>
				<ul class="ul-style">
					<li><label for="startpicker-input">발주신청일</label>
					
					<!-- datepicker -->
						<div class="tui-datepicker-input tui-datetime-input tui-has-focus">
							<input id="startpicker-input" type="text" aria-label="Date">
							<span class="tui-ico-date"></span>
							<div id="startpicker-container" style="margin-left: -1px;"></div>
						</div> <span>-</span>
						<div class="tui-datepicker-input tui-datetime-input tui-has-focus">
							<input id="endpicker-input" type="text" aria-label="Date">
							<span class="tui-ico-date"></span>
							<div id="endpicker-container" style="margin-left: -1px;"></div>
						</div>
						<button class="btn btn-dark btn-sm" id="odSearch">조회</button>
						<button class="btn btn-dark btn-sm" id="resetDpBtn">초기화</button></li>
				</ul>
			</div>
			<div>
				<table class="table">
					<tr>
						<td class="col-5"><h3>발주 신청일 검색 조회</h3>
							<div id="grid2"></div></td>
						<td class="col-7"></td>
					</tr>
				</table><br>
				<ul class="ul-style">
						<li><label for="matNm">자재명</label><input id="matNm"
							name="matNm" readonly> <img id="matNm"
							class="Magnifying-Glass-img" alt="image" data-bs-toggle="modal"
							data-bs-target="#matModal" src="../images/Magnifying_Glass.png"> <input
							id="matCd" name="matCd" type="text" readonly></li>
						<li><label for="actNm">업체명</label><input id="actNm"
							name="actNm" readonly> <img id="actNm"
							class="Magnifying-Glass-img" alt="image" data-bs-toggle="modal"
							data-bs-target="#actModal" src="../images/Magnifying_Glass.png"> <input
							id="actCd" name="actCd" type="text" readonly>
							<button class="btn btn-dark btn-sm">조회</button>
						<button class="btn btn-dark btn-sm">초기화</button></li>
				</ul>
				<h3>자재/업체명 검색 조회</h3>
				<div id="grid3"></div>
			</div>
		</div>
	</div>

	<!-- 자재 목록 모달 -->
	<div class="modal" id="matModal" tabindex="-1"
		aria-labelledby="matModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="matModalLabel">자재 목록</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close" id="matModalClose"></button>
				</div>
				<div class="modal-body">
					<div>
						<div id="modalGrid"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 업체 목록 모달 -->
	<div class="modal" id="actModal" tabindex="-1"
		aria-labelledby="actModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="actModalLabel">업체 목록</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close" id="actModalClose"></button>
				</div>
				<div class="modal-body">
					<div>
						<div id="modalGrid2"></div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<script th:inline="javascript">
	let grid = matAll(); 		// 자재전체목록 그리드
	let grid2 = odDateList(); 	// 발주신청일목록 그리드
	let grid3 = odActList();	// 자재업체명목록 그리드
	
	gridRef(); 					// 그리드 리프레쉬
	
	let modalGrid = matList();	// 자재목록모달 그리드
	let modalGrid2 = actList();	// 업체목록모달 그리드
	
	matListSelect();			// 자재목록 행 클릭 이벤트
	actListSelect();			// 업체목록 행 클릭 이벤트
	odListSearch(); 			// 발주신청일 조회버튼 클릭 이벤트 (조건 조회 탭)
	
	modalRef(); 				// 모달그리드 리프레쉬
	
	datePicker();				// datepicker
	resetDate();				// datepicker 초기화 버튼
	
	/*------------------------------
	// 자재전체조회 그리드
	--------------------------------*/
	function matAll() {
		const grid = new tui.Grid({
	      el: document.getElementById('grid'),
	      bodyHeight: 700,
	      data: [[${odList}]],
	      rowHeaders: ['rowNum'],
	      scrollX: false,
	      scrollY: true,
	      columns: [
	        {
	          header: '자재코드',
	          name: 'mtrCd'
	        },
	        {
	          header: '자재명',
	          name: 'mtrNm'
	        },
	        {
	          header: '단가(원)',
	          name: 'matOddNm'
	        },
	        {
	          header: '발주량',
	          name: 'matOddAmt'
	        },
	        {
	          header: '총액',
	          name: 'matSum'
	        },
	        {
	          header: '업체명',
	          name: 'actNm'
	        },
	        {
	          header: '납기요청일',
	          name: 'matOddDate'
	        }
	      ]
	    });
	    
	    grid.on('focusChange', ev => {
	      console.log('change focused cell!', ev);
	    });
	    
	    return grid;
	}

	/*------------------------------
	// 발주신청일 그리드
	--------------------------------*/
	function odDateList() {
		const grid2 = new tui.Grid({
		      el: document.getElementById('grid2'),
		      bodyHeight: 150,
		      data: null,
		      rowHeaders: ['rowNum'],
		      scrollX: false,
		      scrollY: true,
		      columns: [
		    	  {
			          header: '발주코드',
			          name: 'matOdCd'
			        },
			        {
			          header: '발주신청일',
			          name: 'matOdDd'
			        }
		      ]
		    });
	
		    return grid2;
		}
	
	/*------------------------------
	// 자재/업체명 그리드
	--------------------------------*/
	function odActList() {
		const grid3 = new tui.Grid({
		      el: document.getElementById('grid3'),
		      bodyHeight: 150,
		      data: null,
		      rowHeaders: ['rowNum'],
		      scrollX: false,
		      scrollY: true,
		      columns: [
		    	  {
			          header: '자재코드',
			          name: 'mtrCd'
			        },
			        {
			          header: '자재명',
			          name: 'mtrNm'
			        },
			        {
			        	header: '단가(원)',
				        name: 'matOddMn'
			        },
			        {
			        	header: '발주량',
			        	name: 'matOddAmt'
			        },
			        {
			        	header: '총액',
			        	name: 'matSum'
			        },
			        {
			        	header: '업체명',
			        	name: 'actNm'
			        },
			        {
			        	header: '납기요청일',
			        	name: 'matOddDate'
			        }
		      ]
		    });
	
			return grid3;
		} 
	    
		/*------------------------------
		// 그리드 리프레쉬
		--------------------------------*/
		function gridRef(){
			const allMatTab = document.getElementById('allMat-tab');
			allMatTab.addEventListener('click',function(){
				grid.refreshLayout();
			})
			
			const serchMat = document.getElementById('serchMat-tab');
			serchMat.addEventListener('click',function(){
				grid2.refreshLayout();
				grid3.refreshLayout();
			})
		}
		
		/*------------------------------
		// 자재목록 모달 그리드
		--------------------------------*/	
		function matList(){
			let modalGrid = new tui.Grid({
				el: document.getElementById('modalGrid'),
				bodyHeight: 150,
				data: [[${matList}]],
				rowHeaders: ['rowNum'],
				scrollX: false,
				scrollY: true,
				columns: [
					{
						header: '자재코드',
						name: 'mtrCd',
					},
					{
						header: '자재명',
						name: 'mtrNm',
					},
					{
						header: '규격',
						name: 'mtrStd'
					},
					{
						header: '수량',
						name: 'matSamt'
					}
				]
			});
			return modalGrid;
		}
		
		/*------------------------------
		// 업체목록 모달 그리드
		--------------------------------*/
		function actList(){
			let modalGrid2 = new tui.Grid({
				el: document.getElementById('modalGrid2'),
				bodyHeight: 150,
				data: [[${actList}]],
				rowHeaders: ['rowNum'],
				scrollX: false,
				scrollY: true,
				columns: [
					{
						header: '업체 코드',
						name: 'actCd',
					},
					{
						header: '업체명',
						name: 'actNm',
					}
				]
			});
			return modalGrid2;
		}
		
		/*------------------------------
		// 모달 리프레쉬
		--------------------------------*/
		function modalRef(){
			document.addEventListener('shown.bs.modal', function (){
				modalGrid.refreshLayout();
			});
			document.addEventListener('shown.bs.modal', function (){
				modalGrid2.refreshLayout();
			});
		}
		
		   
		/*------------------------------
		// DatePicker
		--------------------------------*/
		function datePicker() {
			   var today = new Date();
			    var picker = tui.DatePicker.createRangePicker({
			        startpicker: {
			            date: today,
			            input: '#startpicker-input',
			            container: '#startpicker-container'
			        },
			        endpicker: {
			            date: today,
			            input: '#endpicker-input',
			            container: '#endpicker-container'
			        },
			        selectableRanges: [
			            [today, new Date(today.getFullYear() + 1, today.getMonth(), today.getDate())]
			        ]
			    });
			}
		
		/*------------------------
		// DatePicker 초기화버튼 이벤트
		--------------------------*/
		function resetDate() {
			document.getElementById('resetDpBtn').addEventListener('click',function(){
				document.getElementById('startpicker-input').value = today;
				document.getElementById('endpicker-input').value = today;
			});	
		}
		
		/*----------------------------------
		// 발주신청일 조회버튼 클릭 이벤트 (조건 조회 탭)
		------------------------------------*/
		function odListSearch() {
			/* let startDate = document.getElementById('startpicker-input').value; */
			document.getElementById('odSearch').addEventListener('click', function(){
				let matOdDd = document.getElementById('endpicker-input').value;
				$.ajax({
					url: '/odListSearch',
					method: 'POST',
					contentType: 'application/json',					
					data: JSON.stringify({matOdDd:matOdDd}),
					success: function(result){
						console.log(JSON.stringify({matOdDd:matOdDd}));
						console.log(result);
						grid2.resetData(result);
					},
					error: function(reject){
						console.log(reject);
					}
				})
			})
		}
		
		/*----------------------------------
		// 자재 목록 클릭 시 인풋태그 안으로 (조건 조회 탭)
		------------------------------------*/
		function matListSelect() {
			let matNm = document.getElementById('matNm');	// 값이 담길 input 태그
			let matCd = document.getElementById('matCd');	// 값이 담길 input 태그
			modalGrid.on('click', function(ev){
				let data = modalGrid.getRow(ev.rowKey);
				console.log(data);
				matNm.value = data.mtrNm;
				matCd.value = data.mtrCd;
				matModalClose.click();
			})
		}
		
		/*----------------------------------
		// 업체 목록 클릭 시 인풋태그 안으로 (조건조회 탭)
		------------------------------------*/
		function actListSelect() {
			let actNm = document.getElementById('actNm');	// 값이 담길 input 태그
			let actCd = document.getElementById('actCd');	// 값이 담길 input 태그
			modalGrid2.on('click', function(ev){
				let data = modalGrid2.getRow(ev.rowKey);
				console.log(data);
	 			actNm.value = data.actNm;
				actCd.value = data.actCd; 
				actModalClose.click();
			})
		}
	</script>
</div>