<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">

<div class="container" layout:fragment="content">
	<div>
		<div id="mat-od-title">
			<h3>자재 발주 관리</h3>
		</div>
		<hr>
		<!-- 탭 목록(버튼) 설정 -->
		<ul class="nav nav-tabs nav-pills" id="myTab" role="tablist">
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="manage-tab" data-bs-toggle="tab"
					data-bs-target="#plan" type="button" role="tab"
					aria-controls="manage" aria-selected="true">생산계획서용</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link active" id="normal-tab" data-bs-toggle="tab"
					data-bs-target="#normal" type="button" role="tab"
					aria-controls="normal" aria-selected="false">일반</button>
			</li>
		</ul>
		<!-- 탭 본문 시작 -->
		<div class="tab-content" id="myTabContent">
			<div class="tab-pane show active" id="normal" role="tabpanel"
				aria-labelledby="normal-tab">
				<div id="input-group">
					<ul class="ul-style">
						<li><label for="matCode">발주코드</label><input id="matCode"></li>
						<li><label for="matNm">자재명</label><input id="matNm"
							data-bs-toggle="modal" data-bs-target="#matModal" readonly>
							<img class="Magnifying-Glass-img" alt="image"
							data-bs-toggle="modal" data-bs-target="#matModal"
							src="../images/Magnifying_Glass.png"> <input id="matOdCd"
							type="text" data-bs-toggle="modal" data-bs-target="#matModal"
							readonly></li>
						<li><label for="actNm">업체명</label><input id="actNm"
							name="actNm" data-bs-toggle="modal" data-bs-target="#actModal"
							readonly> <img id="actNm" class="Magnifying-Glass-img"
							alt="image" data-bs-toggle="modal" data-bs-target="#actModal"
							src="../images/Magnifying_Glass.png"> <input id="actCd"
							data-bs-toggle="modal" data-bs-target="#actModal" name="actCd"
							type="text" readonly></li>

						<!-- Date Picker -->
						<li><label for="startpicker-input">발주신청일</label>
							<div
								class="tui-datepicker-input tui-datetime-input tui-has-focus">
								<input id="startpicker-input" type="text" aria-label="Date">
								<span class="tui-ico-date"></span>
								<div id="startpicker-container" style="margin-left: -1px;"></div>
							</div> <span>-</span>
							<div
								class="tui-datepicker-input tui-datetime-input tui-has-focus">
								<input id="endpicker-input" type="text" aria-label="Date">
								<span class="tui-ico-date"></span>
								<div id="endpicker-container" style="margin-left: -1px;">
								</div>
							</div>
							<button class="btn btn-dark btn-sm" id="SearchBtn">조회</button>
							<button class="btn btn-dark btn-sm" id="resetBtn">초기화</button></li>
					</ul>
				</div>

				<div id="grid"></div>

				<div style="text-align: right;">
					<button class="btn btn-dark btn-sm" id="insertBtn">추가</button>
					<button class="btn btn-dark btn-sm" id="deleteBtn">삭제</button>
					<button class="btn btn-dark btn-sm" id="saveBtn">저장</button>
				</div>

			</div>

			<!-- 생산계획서용 탭 -->
			<div class="tab-pane" id="plan" role="tabpanel"
				aria-labelledby="plan-tab">
				<div align="right">
					<button class="btn btn-dark btn-sm" data-bs-toggle="modal"
						data-bs-target="#planModal">신규 생산 계획서 조회</button>
				</div>
				<div>
					<table class="table">
						<tr>
							<td class="col-7"><h3>신규 생산 계획</h3>
								<div id="grid2"></div></td>
							<td class="col-1"></td>
							<td class="col-4"><h3>필요 자재</h3>
								<div id="grid3"></div></td>
						</tr>
					</table>

					<h3>자재 발주</h3>
					<div id="grid4"></div>
					<div align="right">
						<button class="btn btn-dark btn-sm" id="resetGridBtn">초기화</button>
						<button class="btn btn-dark btn-sm" id="odSaveBtn">저장</button>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- 자재 목록 모달 -->
	<div class="modal" id="matModal" tabindex="-1"
		aria-labelledby="matModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="matModalLabel">자재 목록</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close" id="matModalClose"></button>
				</div>
				<div class="modal-body">
					<div>
						<div align="center">
							<label for="matModalFilter">자재명</label> <input
								id="matModalFilter" type="text">
							<button class="btn btn-dark btn-sm">검색</button>
							<br>
						</div>
						<div id="modalGrid"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 업체 목록 모달 -->
	<div class="modal" id="actModal" tabindex="-1"
		aria-labelledby="actModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="actModalLabel">업체 목록</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close" id="actModalClose"></button>
				</div>
				<div class="modal-body">
					<div>
						<div align="center">
							<label for="actModalFilter">업체명</label> <input
								id="actModalFilter" type="text">
							<button class="btn btn-dark btn-sm">검색</button>
							<br>
							<div id="modalGrid2"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
		<!-- 신규 생산 계획서 목록 모달 -->
		<div class="modal" id="planModal" tabindex="-1"
			aria-labelledby="planModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="planModalLabel">신규 생산 계획서 리스트</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close" id="planModalClose"></button>
					</div>
					<div class="modal-body">
						<!-- Date Picker -->
						<label for="startpicker-input">발주신청일</label>
						<div class="tui-datepicker-input tui-datetime-input tui-has-focus">
							<input id="startpicker-input2" type="text" aria-label="Date">
							<span class="tui-ico-date"></span>
							<div id="startpicker-container2" style="margin-left: -1px;"></div>
						</div>
						<span>-</span>
						<div class="tui-datepicker-input tui-datetime-input tui-has-focus">
							<input id="endpicker-input2" type="text" aria-label="Date">
							<span class="tui-ico-date"></span>
							<div id="endpicker-container2" style="margin-left: -1px;"></div>
						</div>
						<button class="btn btn-dark btn-sm" id="newPlanLookupBtn">조회</button>
						<!-- <button class="btn btn-dark btn-sm" id="resetBtn2">초기화</button> -->
						<div>
							<div id="modalGrid3"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- 	<span th:text="${odList[0]}"></span> 
		<span th:text="${odList[1]}"></span> 
 		<span th:text="${matList}"></span> 
 		<span th:text="${actList}"></span> -->

	<script th:inline="javascript">
		let odLookUp = tab1GridInit();		// 탭1 조회 그리드
		SearchBtnFn();						// 조회 버튼 클릭시 odLookUp 그리드 표시
		
		let newPlan = tab2GridInit();		// 탭2 새로운생산계획 그리드
		let needMat = tab3GridInit();		// 탭2 필요자재 그리드
		let odMat = tab4GridInit();			// 탭2 자재발주 그리드
		
		let needMatModal = matList();		// 자재목록 모달
		let actList = actListModal();		// 업체목록 모달
		let planModal = addPlan(); 			// 생산계획서 모달
		
		gridRef();							// 그리드 리프레쉬
		modalRef();							// 모달 리프레쉬
		
		getModal();							// 헤더 클릭 모달/총합 이벤트
		getSum();							// 총합
		
		matListSelect();					// 자재목록 행 클릭 이벤트
		actListSelect();					// 업체목록 행 클릭 이벤트
		addNewPlan();						// 신규생산계획 모달창 행 클릭 이벤트
		chkPlanMat();						// 신규생산계획 체크 이벤트
		chkMatList();						// 필요자재목록 체크 이벤트
		
		matModalClickFn();					// 자재 모달 행 클릭 시 인풋 태그로
		actModalClickFn();					// 업체 모달 행 클릭 시 인풋 태그로
		
		datePicker(); 						// datePicker
		datePicker2();						// datePicker2
		resetBtnEvent();					// 검색 조건 초기화 버튼
		/* resetDate(); */						// datepicker2 초기화 버튼
	
		insertOrder();						// 탭1 행 추가(일반 탭)
		deleteOrderList();					// 탭1 행 삭제(일반 탭)
		saveOrder();						// 탭1 행 저장(일반 탭)
		
		odSaveBtn(); 						// 탭2 자재발주 그리드 저장 버튼
		resetTab2Btn();						// 탭2 초기화 버튼
		newPlanLookUpBtn();					// 탭2 신규 생산 계획서 리스트 날짜 조회 버튼
		
	/*------------------------------
	// 자재발주관리 전체 조회(일반 탭)
	--------------------------------*/
	function tab1GridInit(){
		let odLookUp = new tui.Grid({
	      el: document.getElementById('grid'),
	      bodyHeight: 500,
	      data: null,
	      rowHeaders: ['checkbox', 'rowNum'],
	      scrollX: false,
	      scrollY: true,
	      columns: [
	        {
	          header: '발주코드',
	          name: 'matOdCd',
	          sortable: true,
		      filter: {
		    	  type: 'text'
		      }
	        },
	        {
	          header: '자재코드',
	          name: 'mtrCd',
	          sortable: true
	        },
	        {
	          header: '자재명',
	          name: 'mtrNm',
	          sortable: true,
			  filter: {
			        type: 'select'			  
			      }
	        },
	        {
	          header: '단가(원)',
	          name: 'matOddMn',
	          sortable: true,
			  editor: 'text'
	        },
	        {
	          header: '발주량',
	          name: 'matOddAmt',
	          sortable: true,
			  editor: 'text'
	        },
	        {
	          header: '총액',
	          name: 'matSum',
	          sortable: true
	        },
	        {
		      header: '업체코드',
		      name: 'actCd',
		      sortable: true,
			  filter: {
			  	type: 'select'			  
				      	 }
		        },
	        {
	          header: '업체명',
	          name: 'actNm',
	          sortable: true,
			  filter: {
			    type: 'select'			  
			      	 }
	        },
	        {
	          header: '발주신청일',
	          name: 'matOdDd',
	          sortable: true
	        },
	        {
	          header: '납기요청일',
	          name: 'matOddDate',
	          sortable: true,
		      editor: {
		    	  type: 'datePicker',
		    	  options: {
		    		  format: 'yyyy-MM-dd',
		    		  language: 'ko'
		    	  }
		      },
		      validation: {
				     dataType: 'datePicker',
				     required: true
				      }
	        }
	      ]
	    });
	    
	    return odLookUp;
	}
		
	/*--------------------------------
	// 조회 버튼 클릭 시 그리드 등장
	----------------------------------*/
	function SearchBtnFn() {
		document.getElementById('SearchBtn').addEventListener('click',function(){
			let matOdCd = document.getElementById('matOdCd').value; // 자재 코드
			let actNm = document.getElementById('actNm').value; // 업체 이름
			let matInDate = document.getElementById('startpicker-input').value; // 시작 날짜
			let matEdate = document.getElementById('endpicker-input').value; // WHERE절 비교 용으로 유통기한에 end Date담음
			
			let data = {mtrCd: matOdCd, actNm: actNm, matInDate: matInDate, matEdate: matEdate};
			
			$.ajax({
				url: '/matOdList',
				method: 'POST',
				contentType: 'application/JSON',
				data: JSON.stringify(data),
				success: function(result){
					// 그리드 표시
					odLookUp.resetData(result)
					
					// 발주코드 조회탭 검색 버튼
					let searchedOdCd = document.getElementById('matCode');
					if (searchedOdCd.value != null || searchedOdCd.value != '') {
						odLookUp.filter('matOdCd', [{code: 'contain', value: searchedOdCd.value}]);
					}
				},
				error: function(reject) {
					console.log(reject);
				}
			})
		})
	}
	
    /*---------------------------------
	// 해당하는 header의 모달창 띄우기(일반 탭)
	-------------------------------------*/
	function getModal() {
		odLookUp.on('click',function(ev){
			// 자재 목록 선택 시 행으로 가져오기
	   		if(ev.columnName =='mtrCd' || ev.columnName =='mtrNm'){
	   			$('#matModal').modal('show');
	   			needMatModal.refreshLayout();
	   			
	   		// 업체 목록 선택 시 행으로 가져오기
	   		}else if (ev.columnName =='actCd' || ev.columnName =='actNm'){
	   	   			$('#actModal').modal('show');
	   	   		 actList.refreshLayout();
	   	   		}
	   		
	   		// 단가 * 발주량 = 총합
	   		else if (ev.columnName == 'matSum'){
	   			let data = odLookUp.getRow(ev.rowKey);
	   			let val =  odLookUp.getFocusedCell().rowKey;
				if(data.matOddMn != null && data.matOddAmt != null){
					odLookUp.setValue(val, 'matSum', (data.matOddMn * data.matOddAmt));
				}
	   		}
	   	});
		
    }
    
	/*------------------------------
	// 신규생산계획조회(생산계획서용 탭)
	--------------------------------*/
	function tab2GridInit(){
		let newPlan = new tui.Grid({
		      el: document.getElementById('grid2'),
		      bodyHeight: 200,
		      data: null,
		      rowHeaders: ['checkbox', 'rowNum'],
		      scrollX: false,
		      scrollY: true,
		      columns: [
		        {
		          header: '상세계획번호',
		          name: 'pplnCd',
		          sortable: true
		        },
		        {
		          header: '제품코드',
		          name: 'prdCd',
		          sortable: true,
				  filter: {
						 type: 'select'			  
						 }
		        },
		        {
		          header: '제품명',
		          name: 'prdNm',
		          sortable: true,
				  filter: {
						 type: 'select'			  
						 }
		        },
		        {
		          header: '계획량',
		          name: 'pplndAmt',
		          sortable: true
		        },
		        {
		          header: '주문납기일',
		          name: 'deDate',
		          sortable: true
		        }
		      ]
		    });
		 
		   	return newPlan;
	}

	/*------------------------------
	// 필요자재 리스트(생산계획 탭)
	--------------------------------*/
	function tab3GridInit() {
		let needMat = new tui.Grid({
		      el: document.getElementById('grid3'),
		      bodyHeight: 200,
		      data: null,
		      rowHeaders: ['checkbox', 'rowNum'],
		      scrollX: false,
		      scrollY: true,
		      columns: [
		    	  {
			          header: '자재코드',
			          name: 'mtrCd',
			          sortable: true,
					  filter: {
							 type: 'select'			  
							 }
			        },
			        {
			          header: '자재명',
			          name: 'mtrNm',
			          sortable: true,
					  filter: {
							 type: 'select'			  
							 }
			        },
			        {
			          header: '소모량',
			          name: 'bomAmt',
			          sortable: true
			        }
		      ]
		    });
			return needMat;
	}
	
	/*------------------------------
	// 자재발주 리스트(생산계획 탭)
	--------------------------------*/
	function tab4GridInit() {
		let odMat = new tui.Grid({
		      el: document.getElementById('grid4'),
		      bodyHeight: 200,
		      data: null,
		      rowHeaders: ['rowNum'],
		      scrollX: false,
		      scrollY: true,
		      columns: [
		    	  {
			          header: '자재코드',
			          name: 'mtrCd',
			          sortable: true,
					  filter: {
							 type: 'select'			  
							 }
			        },
			        {
			          header: '자재명',
			          name: 'mtrNm',
			          sortable: true,
					  filter: {
							 type: 'select'			  
							 }
			        },
/* 			        {
				      header: '안전발주량',
				      name: 'safeOd'
				    }, */
			        {
				      header: '단가(원)',
				      name: 'matOddMn',
				      sortable: true,
					  editor: 'text'
				    },
				    {
					  header: '발주량',
					  name: 'matOddAmt',
					  sortable: true,
					  editor: 'text'
					},
					{
					  header: '총액',
					  name: 'matSum',
					  sortable: true
					},
					{
					  header: '업체코드',
					  name: 'actCd',
					  sortable: true,
					  filter: {
							 type: 'select'			  
							 }
					},
					{
					  header: '업체명',
					  name: 'actNm',
					  sortable: true,
					  filter: {
							 type: 'select'			  
							 }
					},
					{
					  header: '발주신청일',
					  name: 'matOdDd',
					  sortable: true
					},
					{
					  header: '납기요청일',
					  name: 'matOddDate',
					  sortable: true,
				      editor: {
				    	  type: 'datePicker',
				    	  options: {
				    		  format: 'yyyy-MM-dd',
				    		  language: 'ko'
				    	  }
				      },
				      validation: {
						     dataType: 'datePicker',
						     required: true
						      }
					}
		      ]
		    });
	    
	    	return odMat;
		}
	
	/*------------------------------
	// 그리드 리프레쉬
	--------------------------------*/
	function gridRef() {
		const manageTab = document.getElementById('normal-tab');
			manageTab.addEventListener('click',function(){
				odLookUp.refreshLayout();
		})
		
		const insertTab = document.getElementById('manage-tab');
		insertTab.addEventListener('click',function(){
			newPlan.refreshLayout();
			needMat.refreshLayout();
			odMat.refreshLayout();
		})
	};
	
	/*------------------------------
	// 자재목록 모달 그리드(일반 탭)
	--------------------------------*/
	function matList() {
		let needMatModal = new tui.Grid({
			el: document.getElementById('modalGrid'),
			bodyHeight: 250,
			data: [[${matList}]],
			rowHeaders: ['rowNum'],
			scrollX: false,
			scrollY: true,
			columns: [
				{
					header: '자재코드',
					name: 'mtrCd',
					sortable: true,
					  filter: {
						  type: 'select'			  
						  }
				},
				{
					header: '자재명',
					name: 'mtrNm',
					sortable: true,
					  filter: {
						 type: 'select'			  
						 }
				}
			]
		});
		return needMatModal;
	}
	
	/*------------------------------
	// 업체목록 모달 그리드(일반 탭)
	--------------------------------*/
	function actListModal() {
		let actList = new tui.Grid({
			el: document.getElementById('modalGrid2'),
			bodyHeight: 250,
			data: [[${actList}]],
			rowHeaders: ['rowNum'],
			scrollX: false,
			scrollY: true,
			columns: [
					{
						header: '업체 코드',
						name: 'actCd',
						sortable: true,
						  filter: {
							  type: 'select'			  
							  }
					},
					{
						header: '업체명',
						name: 'actNm',
						sortable: true,
						  filter: {
							  type: 'select'			  
							  }
					}
				]
			});
		return actList;
	}
	
	/*----------------------------------
	// 자재 목록 클릭 시 빈 그리드 안으로 (일반 탭)
	------------------------------------*/
	function matListSelect() {
		needMatModal.on('click', function(ev){
			let data = needMatModal.getRow(ev.rowKey);
			let val = odLookUp.getFocusedCell().rowKey;
			
			odLookUp.setValue(val, 'mtrCd', data.mtrCd);
			odLookUp.setValue(val, 'mtrNm', data.mtrNm);
			matModalClose.click();
		})
	}
	
	/*----------------------------------
	// 업체 목록 클릭 시 빈 그리드 안으로(일반 탭)
	------------------------------------*/
	function actListSelect() {
		let actNm = document.getElementById('actNm');	// 값이 담길 input 태그
		let actCd = document.getElementById('actCd');	// 값이 담길 input 태그
		actList.on('click', function(ev){
			let data = actList.getRow(ev.rowKey);
			let val =  odLookUp.getFocusedCell().rowKey;
			
			odLookUp.setValue(val, 'actCd', data.actCd);
			odLookUp.setValue(val, 'actNm', data.actNm);

			actModalClose.click();
		})
	}
	
	/*------------------------------
	// 생산계획 모달 그리드(생산계획서용 탭)
	--------------------------------*/
	function addPlan() {
		let planModal = new tui.Grid({
			el: document.getElementById('modalGrid3'),
			bodyHeight: 400,
			data: [[${addNewPlan}]],
			rowHeaders: ['rowNum'],
			scrollX: false,
			scrollY: true,
			columns: [
				{
					header: '생산 계획 코드',
					name: 'pplnCd',
					sortable: true
				},
				{
					header: '계획명',
					name: 'pplnName',
					sortable: true
				},
				{
					header: '계획일자',
					name: 'pplnDate',
					sortable: true
				}
			]
		});
		
		return planModal;
	}
	
	 /*-------------------------------------------------
	// 새로운계획 모달에서 행 클릭 시에 그리드에 추가(생산계획서용 탭)
	---------------------------------------------------*/
  	function addNewPlan() {
 		planModal.on('click', function(ev) {
	 	    let data = planModal.getRow(ev.rowKey);
	 	    console.log(data);
	 	   			$.ajax({
					url: '/matAddNewPlan',
					type: 'POST',
					contentType: 'application/json',	// json타입으로 반환 하겠다.
					data: JSON.stringify(data),			// 데이터를 json타입으로.
					success: function(result) {
						newPlan.resetData(result);
						planModalClose.click();
					},
					error: function(reject) {
						console.log(reject);
					}
				})
 			})
		}  
	 
	 /*-------------------------------------------------------
	// 신규생산계획 체크 시 자재목록으로 넘어가도록 처리.(생산계획서용 탭)
	----------------------------------------------------------*/
	function chkPlanMat() {
		newPlan.on('click', function(){
			let data = newPlan.getCheckedRows();
			$.ajax({
				url: '/needMatList',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(data[0]),
				success: function(result) {
					needMat.resetData(result);
				},
				error: function(reject) {
					console.log(reject);
				}
			})
			
		})
	 } 
	 
	 /*-----------------------------------------
	// 필요자재 클릭시 자재발주 리스트로(생산계획서용 탭)
	-------------------------------------------*/
	function chkMatList() {
		needMat.on('click', function(){
			let data = needMat.getCheckedRows();
 			$.ajax({
				url: '/chkMatList',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(data[0]),
				success: function(result) {
					odMat.appendRows(result);
				},
				error: function(reject) {
					console.log(reject);
				}
			}) 
		})
	 } 
	 
	/*------------------------------
	// 모달 그리드 리프레쉬
	--------------------------------*/
	function modalRef(){
		document.addEventListener('shown.bs.modal', function (){
			needMatModal.refreshLayout();
		});

		document.addEventListener('shown.bs.modal', function (){
			actList.refreshLayout();
		});
	
		document.addEventListener('shown.bs.modal', function (){
			planModal.refreshLayout();
		});
	}
	
	/*------------
	// datepicker
	----------------*/
	function datePicker() {
		rangeDatepickerInit('#startpicker-input', '#startpicker-container','#endpicker-input','#endpicker-container')
		document.getElementById('startpicker-input').value = null;
		document.getElementById('endpicker-input').value = null;
	}
	
	/*------------
	// datepicker2
	----------------*/
	function datePicker2() {
		rangeDatepickerInit('#startpicker-input2', '#startpicker-container2','#endpicker-input2','#endpicker-container2')
		document.getElementById('startpicker-input2').value = null;
		document.getElementById('endpicker-input2').value = null;
	}
	
	/*------------------------
	// 검색 조건 초기화버튼 이벤트
	--------------------------*/
	function resetBtnEvent() {
		document.getElementById('resetBtn').addEventListener('click',function(){
			document.getElementById('startpicker-input').value = null;
			document.getElementById('endpicker-input').value = null;
			document.getElementById('matCode').value = '';
			document.getElementById('matNm').value = '';
			document.getElementById('matOdCd').value = '';
			document.getElementById('actNm').value = '';
			document.getElementById('actCd').value = '';
		});	
	}
	
	/*--------------------------------
	// 모달창 안의 DatePicker 초기화버튼 이벤트
	----------------------------------*/
/* 	function resetDate() {
		document.getElementById('resetBtn2').addEventListener('click',function(){
			document.getElementById('startpicker-input2').value = null;
			document.getElementById('endpicker-input2').value = null;
		});	
	} */
	
	/*------------------------
	// 자재발주 전체조회 행 추가 버튼
	----------------------------*/
	function insertOrder(){
		let insertBtn = document.getElementById('insertBtn');
		insertBtn.addEventListener('click', function(){
	    let rowData = [{matOdCd: "", mtrCd: "", 
		    				mtrNm: "", matOddMn: "", matOddAmt: "", matSum : "" ,
		    				actCd: "", actNm: "", matOdDd: "", matOddDate:""}]
		    rowData.matOdDd = today;
		    odLookUp.appendRow(rowData);
		})
	}
	
	/*------------------------
	// 자재발주 전체조회 행 저장 버튼
	----------------------------*/
	function saveOrder(){
		let saveBtn = document.getElementById('saveBtn');
		saveBtn.addEventListener('click', function(ev){
			let data = odLookUp.getCheckedRows();
			console.log(JSON.stringify(data[0].matOddDate));
			console.log(data);
			Swal.fire({
			      title: '저장 하시겠습니까?',
			      icon: 'warning',
			      showCancelButton: true,
			      confirmButtonColor: '#3085d6',
			      cancelButtonColor: '#d33',
			      confirmButtonText: '승인',
			      cancelButtonText: '취소',
			      
			    }).then((result) => {
			      if (result.isConfirmed) {
			        $.ajax({
			        	url: '/matOd',
			        	method: 'POST',
			        	contentType: 'application/JSON',
						data: JSON.stringify(data),
						success: function(result){
							console.log(result);
							if(result >= 2){
								Swal.fire({
									icon: 'success',
									title :'저장이 완료되었습니다!'});
								setTimeout(() => location.reload(),400);
							} else {
								Swal.fire({
									icon: 'error',
									title :'저장에 실패하였습니다!'});
							}
						},
						error: function(reject){
							console.log(reject);
						}
			        })
			      }
			   })
		})
	}
	
	/*------------------------
	// 자재발주 전체조회 행 여러건 삭제 버튼
	----------------------------*/
	function deleteOrderList() {
		let deleteBtn = document.getElementById('deleteBtn');
		deleteBtn.addEventListener('click', function(){
			let data = odLookUp.getCheckedRows();
			let list = [];
			let matOdCd = '';
			for(let i=0; i<data.length; i++){
				matOdCd = data[i].matOdCd;
				list.push({matOdCd});
			}
			console.log(list);
			
			Swal.fire({
			      title: '정말로 삭제 하시겠습니까?',
			      icon: 'warning',
			      showCancelButton: true,
			      confirmButtonColor: '#3085d6',
			      cancelButtonColor: '#d33',
			      confirmButtonText: '승인',
			      cancelButtonText: '취소',
			      
			    }).then((result) => {
			      if (result.isConfirmed) {
			    	if(data.length==1){
				        $.ajax({
				        	url: '/matOd',
				        	method: 'DELETE',
				        	contentType: 'application/JSON',
							data: JSON.stringify(data[0]),
							success: function(result){
								console.log(result);
								if(result == 1 || result == -1){
									Swal.fire({
										icon: 'sussecc',
										title :'삭제에 완료되었습니다!'});
						        	odLookUp.removeCheckedRows();
								} else {
									Swal.fire({
										icon: 'error',
										title :'삭제에 실패하였습니다!'});
								}
							},
							error: function(reject){
								console.log(reject);
							}
			        	})
			        	
			          // 다건 삭제 시작	
			    	} else if(data.length > 1) {
			    		// 자재발주코드 삭제 ajax
				        $.ajax({
				        	url: '/matOdDel',
				        	method: 'DELETE',
				        	contentType: 'application/JSON',
							data: JSON.stringify(list),
							success: function(result){
								console.log(result);
								if(result != 1 && result != -1 && result != 0){
									Swal.fire({
										icon: 'sussecc',
										title :'삭제에 완료되었습니다!'});
						        	odLookUp.removeCheckedRows();
						        	// 자재발주상세코드 삭제 ajax
						        	$.ajax({
						        		url: '/matOddDel',
							        	method: 'DELETE',
							        	contentType: 'application/JSON',
										data: JSON.stringify(list),
										success: function(result){
											console.log(result);
											if(result > 1){
												console.log('자재발주상세코드 삭제: ' + result)
											}
										},
										error: function(reject){
											console.log(reject);
										}
						        	})
						        	odLookUp.removeCheckedRows();
								} else {
									Swal.fire({
										icon: 'error',
										title :'삭제에 실패하였습니다!'});
								}
							},
							error: function(reject){
								console.log(reject);
							}
			        	})
			    	}
			      }
			   })
		})
	}
	
	/*------------------------------
	// 자재 발주 그리드에 클릭 시 총합구하기
	----------------------------------*/
	function getSum() {
		odMat.on('click',function(ev){
	   		// 단가 * 발주량 = 총합
	   		if (ev.columnName == 'sumPrice'){
	   			let data = odMat.getRow(ev.rowKey);
	   			let val =  odMat.getFocusedCell().rowKey;
				if(data.matOddMn != null && data.matOddAmt != null){
					odMat.setValue(val, 'sumPrice', (data.matOddMn * data.matOddAmt));
				}
	   		}
	   	});
		
    }
	
	/*------------------------
	// 자재 발주 그리드 저장 버튼
	----------------------------*/
	function odSaveBtn() {
		let odSaveBtn = document.getElementById('odSaveBtn');
		odSaveBtn.addEventListener('click',function(){
			let data = odMat.getData();
			let planData = newPlan.getCheckedRows();
			console.log(planData[0])
			
			// 여러건 저장
			Swal.fire({
			      title: '출고처리 하시겠습니까?',
			      icon: 'warning',
			      showCancelButton: true,
			      confirmButtonColor: '#3085d6',
			      cancelButtonColor: '#d33',
			      confirmButtonText: '승인',
			      cancelButtonText: '취소',
			      
			    }).then((result) => {
			      if (result.isConfirmed) {
			        $.ajax({
			        	url: '/matOd',
			        	method: 'POST',
			        	contentType: 'application/JSON',
						data: JSON.stringify(data),
						success: function(result){
							console.log(result);
							if(result >= 1){
								Swal.fire({
									icon: 'success',
									title :'출고가 완료되었습니다!'});
								setTimeout(() => location.reload(),400);
							} else {
								Swal.fire({
									icon: 'error',
									title :'출고에 실패했습니다!'});
							}
						}, // success end
						error: function(reject){
							console.log(reject);
						}
			        }) // ajax end
			        
					// 체크된 pplnCd의 상태를 미지시로 업데이트
					$.ajax({
			        	url: '/matOd',
			        	method: 'PUT',
			        	contentType: 'application/JSON',
						data: JSON.stringify(planData[0]),
						success: function(result){
							console.log(result)
							console.log(planData[0].pplnCd + ' 미지시로 업데이트 완료!')
						},
						error: function(reject){
							console.log(reject);
						}
					}) // ajax end
			      }
			   })
			})
		}
	
	/*-----------------------------
	// 신규생산 계획서 리스트 날짜 조회버튼
	---------------------------------*/
	function newPlanLookUpBtn() {
		document.getElementById('newPlanLookupBtn').addEventListener('click', function(){
			let startDate = document.getElementById('startpicker-input2').value;
			let endDate = document.getElementById('endpicker-input2').value;
			let list = {matOdDd:endDate, matOddDate:startDate};
			console.log(list)
			// 시작 일 <= 검색 날짜 <= 마지막 일
			$.ajax({
				url: '/newPlanLookUpBtn',
				method: 'POST',
				contentType: 'application/json',					
				data: JSON.stringify(list),
				success: function(result){
					console.log(result);
					planModal.resetData(result);
				},
				error: function(reject){
					console.log(reject);
				}
			})
		});
	}

	/*-----------------------------
	// 탭2 초기화 버튼
	---------------------------------*/
 	function resetTab2Btn() {
		document.getElementById('resetGridBtn').addEventListener('click',function(ev){
			let data = [];
			
			newPlan.resetData(data);
			needMat.resetData(data);
			odMat.resetData(data);
		})
	}
	
	
	/*--------------------------------
	// 자재 모달 행 클릭시 인풋 태그로
	----------------------------------*/
	function matModalClickFn() {
		needMatModal.on('click', function(ev){
			let data = needMatModal.getRow(ev.rowKey);
			console.log(data);
			let matNm = document.getElementById('matNm');
			let matCd = document.getElementById('matOdCd');

			
			matNm.value = data.mtrNm;
			matCd.value = data.mtrCd;

			
			mtrCloseBtn.click();
		})
	}
	
	/*--------------------------------
	// 업체 모달 행 클릭시 인풋 태그로
	----------------------------------*/
	function actModalClickFn() {
		actList.on('click', function(ev){
			let data = actList.getRow(ev.rowKey);
			console.log(data);
			
			let actNm = document.getElementById('actNm');
			let actCd = document.getElementById('actCd');
			
			actNm.value = data.actNm;
			actCd.value = data.actCd;
			
			actCloseBtn.click();
		})
	}
	
</script>
</div>