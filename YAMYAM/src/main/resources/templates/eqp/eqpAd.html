<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">

<head>
<meta charset="UTF-8">
<title>YAMYAM</title>
<style type="text/css">
	#eqpTable {
		margin-left: 40px;
		margin-top: 30px;
		height: 230px;
	}
	
	#eqpTable th {
		width: 90px;
	}
	
	#eqpTable input[type="text"] {
		margin-right: 20px;
	}
	
	input#eqpTypeCd,
	input#eqpTypeNm {
		background-color: gainsboro;
		width: 100px;
	}
	
	#eqpTable tr {
		border-bottom: 1px #C9BABA solid;
		border-top: 1px #C9BABA solid;
	}
	
	select option[value=""][disabled] {
		display: none;
	}
</style>
</head>

<body>
	<div class="container" layout:fragment="content">
		<h3>설비 관리</h3>
		<hr>
		
		<div>
			<!-- 탭 목록 start -->
			<ul class="nav nav-tabs nav-pills" id="myTab" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="select-tab" data-bs-toggle="tab"
						data-bs-target="#select" type="button" role="tab"
						aria-controls="select" aria-selected="true">조회</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="manage-tab" data-bs-toggle="tab"
						data-bs-target="#manage" type="button" role="tab"
						aria-controls="manage" aria-selected="false">관리</button>
				</li>
			</ul>
			<!-- 탭 목록 end -->
			
			<!-- 탭 본문 -->
			<div class="tab-content" id="myTabContent" style="border: 1px solid black;">
				
				<!-- 조회탭 본문 start -->
				<div class="tab-pane show active" id="select" role="tabpanel"
					aria-labelledby="select-tab">
					<div style="margin-top:10px">
						<ul class="ul-style">
							<li>
								<form action="" onsubmit="return false">
									<label for="eName" style="margin-left:20px; margin-right:20px;">설비명</label>
									<input type="text" name="eqpNm" id="searchedEqpNm">
									<button type="button" class="btn btn-dark btn-sm" id="searchBtn">검색</button>
									<button type="reset" class="btn btn-dark btn-sm" id="resetFilter">초기화</button>
								</form>
								<button type="button" class="btn btn-dark btn-sm me-md-2" style="float:right" id="deleteBtn">삭제</button>
							</li>
						</ul>
						<!-- 조회 grid -->
						<div id="selectEqp"></div>
					</div>
				</div>
				<!-- 조회탭 본문 end -->
				
				<!-- 관리탭 본문 start -->
				<div class="tab-pane" id="manage" role="tabpanel"
					aria-labelledby="manage-tab">
					<form action="#">
						<div style="margin: 15px;">
							<div class="d-md-flex justify-content-md-end">
								<button type="button" class="btn btn-dark btn-sm me-md-2" data-bs-toggle="modal"
													data-bs-target="#eqpListModal">설비 목록</button>
								<input type="reset" class="btn btn-dark btn-sm me-md-2" id="reset">
								<button type="button" class="btn btn-dark btn-sm me-md-2" id="insertUpdateBtn">저장</button>
							</div>
							
							<hr style="height:3px;">
							
							<!-- 테이블과 사진 배치 start -->
							<div class="row">
								<div class="col-9">
									<table id="eqpTable">
										<tr>
											<th>설비코드</th>
											<td>
												<input type="text" id="eqpCd" name="eqpCd" readonly>
											</td>
											<th>설비업체</th>
											<td>
												<select class="form-select form-select-sm" name="actCd" id="actCd" style="width:200px">
													<option value="" disabled selected>설비업체선택</option>
											        <option th:each="act : ${eqpActList}" th:value="${act.actCd}" th:text="${act.actNm}">
											    </select>
											</td>
											<th>가동여부</th>
											<td>
								  			    <select class="form-select form-select-sm" name="eqpSts" id="eqpSts">
								  			    	<option value="" disabled selected>가동여부선택</option>
								  			    	<option th:each="sts : ${eqpStsList}" th:value="${sts.commdCd}" th:text="${sts.commdNm}">
											    </select>
											</td>
										</tr>
										<tr>
											<th>설비명</th>
											<td>
												<input type="text" id="eqpNm" name="eqpNm">
											</td>
											<th>제작일자</th>
											<td>
												<input type="text" id="mkDate" name="mkDate">
											</td>
											<th>UPH</th>
											<td>
												<input type="text" id="uph" name="uph">
											</td>
										</tr>
										<tr>
											<th>모델명</th>
											<td>
												<input type="text" id="mdNm" name="mdNm">
											</td>
											<th>구매일자</th>
											<td>
												<input type="text" id="buyDate" name="buyDate">
											</td>
											<th>온도</th>
											<td>
												<input type="text" id="highTemp" name="highTemp" style="margin-right: 0; width: 90px;"> - 
												<input type="text" id="lowTemp" name="lowTemp" style="width: 90px; margin-right: 0;"> ℃
											</td>
										</tr>
										<tr>
											<th>점검주기</th>
											<td>
												<input type="text" id="chkCycle" name="chkCycle">
											</td>
											<th>설비구분</th>
											<td colspan="1">
												<!-- 설비구분 공통상세코드 및 코드명을 name과 id에 넣어주기 -->
												<input type="text" id="eqpTypeCd" name="eqpTypeCd" style="margin-right: 0;" readonly>
												<img class="Magnifying-Glass-img" alt="image" data-bs-toggle="modal"
													data-bs-target="#eqpTypeModal" src="../images/Magnifying_Glass.png">
												<input type="text" id="eqpTypeNm" name="eqpTypeNm" readonly>
											</td>
										</tr>
									</table>
								</div>
								<div class="col-3">
									<div id="imgDiv" width=" 300px" height="300px">
										<img id="imgTag" name="imgTag" alt="설비사진" src="" width=" 300px" height="300px">
									</div>
									<input type="file" id="img" name="img">
								</div>
							</div>
							<!-- 테이블과 사진 배치 end -->
						</div>
					</form>
				</div>
				<!-- 관리탭 본문 end -->
			</div>
			<!-- 탭 본문 end -->
		</div>
		
		<!-- 설비목록 modal -->
		<div class="modal" id="eqpListModal" tabindex="-1"
			aria-labelledby="#eqpListLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="eqpListLabel">설비 목록</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div id="eqpListModalGrid"></div>
					</div>
	
				</div>
			</div>
		</div>
		
		<!-- 설비업체 modal -->
		<div class="modal" id="actListModal" tabindex="-1"
			aria-labelledby="#actListModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="actListModalLabel">설비업체 목록</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div id="actListModalGrid"></div>
					</div>
	
				</div>
			</div>
		</div>
		
		<!-- 설비구분 modal -->
		<div class="modal" id="eqpTypeModal" tabindex="-1"
			aria-labelledby="#eqpTypeLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="eqpTypeLabel">설비 구분</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div id="eqpTypeModalGrid"></div>
					</div>
				</div>
			</div>
		</div>
		
		<script type="text/javascript">
			let selectEqpGrid = selectTabInit(); 		// 조회탭 그리드 초기화
			let eqpListModalGrid = eqpListModalInit();	// 관리탭 설비목록 모달 그리드 초기화
			let eqpTypeModalGrid = eqpTypeModalInit();	// 관리탭 설비구분 모달 그리드 초기화
			
			searchBtn();								// 조회탭 검색버튼
			searchResetBtn();							// 조회탭 검색 초기화 버튼
			deleteBtn();								// 조회탭 선택 삭제 버튼
			
			eqpTypeSelect();							// 관리탭 설비구분 선택 모달창 refresh
			eqpListSelect();							// 관리탭 설비목록 모달 시 refresh 
			insertUpdateBtn();							// 관리탭 form태그 내용으로 insert OR update 하는 버튼
			inputImgInteract();							// 관리탭 input#IMG에 값 들어오면 img태그 만들어서 사진 나오는 이벤트
			imgTagReset();								// 관리탭 초기화 버튼 눌렀을때 img태그 src도 같이 초기화
			
			
			
			// toastr
			toastr.options = {
				    "closeButton": false,
				    "newestOnTop": true,
				    "positionClass": "toast-top-center",
				    "preventDuplicates": true,
				    "extendedTimeOut" : 1500, 
				    "timeOut" : 2500
			}
			
			
			
			
			/* ---------------
			조회탭 그리드
			--------------- */
			function selectTabInit() {
			
				let selectEqpGrid = new tui.Grid({
				      el: document.getElementById('selectEqp'),
				      bodyHeight: 500, // 스크롤
				      rowHeaders: ['checkbox'],
				      scrollX: false,
				      scrollY: true,
				      columns: [
				        {
				          header: '설비코드',
				          name: 'eqpCd',
					      sortable: true,
					      align: 'center'
				        },
				        {
				          header: '설비명',
				          name: 'eqpNm',
					      sortable: true,
					      align: 'left',
					      filter: {
					    	  type: 'text'
					      }
				        },
				        {
				          header: '모델명',
				          name: 'mdNm',
					      sortable: true,
					      align: 'center'
				        },
				        {
				          header: '설비업체명',
				          name: 'actNm',
					      sortable: true,
					      align: 'left'
				        },
				        {
				          header: '제작일자',
				          name: 'mkDate',
					      sortable: true,
					      align: 'right'
				        },
				        {
				          header: '구매일자',
				          name: 'buyDate',
					      sortable: true,
					      align: 'right'
				        },
				        {
				          header: '최고온도',
				          name: 'highTemp',
					      sortable: true,
					      align: 'right'
				        },
				        {
				          header: '최저온도',
				          name: 'lowTemp',
					      sortable: true,
					      align: 'right'
				        },
				        {
				          header: '점검주기(주기일수)',
				          name: 'chkCycle',
					      sortable: true,
					      align: 'right'
				        },
				        {
				          header: '마지막점검일',
				          name: 'chkDate',
					      sortable: true,
					      align: 'right'
				        },
				        {
				          header: '설비구분',
				          name: 'eqpType',
					      align: 'left',
					      filter: {
					    	  type: 'select'
					      }
				        },
				        {
				          header: '설비상태',
				          name: 'eqpSts',
					      align: 'left',
					      filter: {
					    	  type: 'select'
					      }
				        }
				      ]
				});
				
				// 설비 리스트 전제 조회
				$.ajax({
					url:'/getEqpList',
					dataType: 'json',
					success: function (data) {
						selectEqpGrid.resetData(data);
					},
					error: function (reject) {
						console.log(reject);
					}
				})
				
				return selectEqpGrid;
			}
			
			
			
			/* ---------------
			관리탭 설비목록 모달 grid 초기화
			--------------- */
			function eqpListModalInit() {
				let eqpListModalGrid = new tui.Grid({
					el: document.getElementById('eqpListModalGrid'),
					bodyHeight: 400,
					rowHeaders: ['rowNum'],
					scrollX: false,
					scrollY: true,
					columns: [{
				          header: '설비코드',
				          name: 'eqpCd',
				          align: 'center'
				        },
				        {
				          header: '설비명',
				          name: 'eqpNm',
				          align: 'left'
				        },
				        {
				          header: '설비구분',
				          name: 'eqpType',
				          align: 'left'
					    }
			      	] 
				});
				
				// 설비 목록 정보 가져오기
				$.ajax({
					url: '/eqpStsListModal',
					dataType: "json",
					success: function (data) {
						eqpListModalGrid.resetData(data);
					},
					error: function (reject) {
						console.log(reject);
					}
				});
				
				// 관리탭 설비목록 모달에서 하나 클릭시, 설비전체 input태그에 값 넣어주고 모달창 닫기
				eqpListModalGrid.on('click', function (ev) {
					let rowData = eqpListModalGrid.getRow(ev.rowKey);
					$.ajax({
						url: '/getEqp',
						type: 'post',
						data: {eqpCd : rowData.eqpCd},
						success: function (data) {
							document.getElementById('eqpCd').value = data.eqpCd;
							document.getElementById('eqpNm').value = data.eqpNm;
							document.getElementById('mdNm').value = data.mdNm;
							document.getElementById('chkCycle').value = data.chkCycle;
							document.getElementById('actCd').value = data.actCd;
							document.getElementById('mkDate').value = data.mkDate;
							document.getElementById('buyDate').value = data.buyDate;
							document.getElementById('eqpTypeCd').value = data.eqpTypeCd;
							document.getElementById('eqpTypeNm').value = data.eqpTypeNm;
							document.getElementById('eqpSts').value = data.eqpSts;
							document.getElementById('uph').value = data.uph;
							document.getElementById('highTemp').value = data.highTemp;
							document.getElementById('lowTemp').value = data.lowTemp;
							document.getElementById('imgTag').src = '/images/' + data.img;
							
							document.querySelector('#eqpListModal button.btn-close').click();
						},
						error: function (reject) {
							console.log(reject);
						}
					});
				});
				
				return eqpListModalGrid;
			}
			
			
			
			/* ---------------
			관리탭 설비구분 모달 grid 초기화
			--------------- */
			function eqpTypeModalInit() {
				let eqpTypeModalGrid = new tui.Grid({
					el: document.getElementById('eqpTypeModalGrid'),
					bodyHeight: 250,
					data: [
						{
							code: 'eqptype-01',
							name: '만두 배합'
						},
						{
							code: 'eqptype-02',
							name: '만두 성형',
						},
						{
							code: 'eqptype-01',
							name: '만두 배합'
						},
						{
							code: 'eqptype-02',
							name: '만두 성형',
						},
						{
							code: 'eqptype-02',
							name: '만두 성형',
						},
						{
							code: 'eqptype-02',
							name: '만두 성형',
						}
					],
					rowHeaders: ['rowNum'],
					scrollX: false,
					scrollY: true,
					columns: [{
				          header: '설비구분코드',
				          name: 'eqpTypeCd',
				          align: 'center'
				        },
				        {
				          header: '설비구분명',
				          name: 'eqpTypeNm',
				          align: 'left'
				        },
			      ] 
				});
				
				
				// 상세공통의 설비구분코드 설비구분명 eqpTypeModalGrid에 set
				$.ajax({
					url: '/eqpTypeListModal',
					dataType: "json",
					success: function (data) {
						eqpTypeModalGrid.resetData(data);
					},
					error: function (reject) {
						console.log(reject);
					}
				});
				
				
				/* ---------------
				관리탭 설비구분 돋보기 모달에서 하나 클릭시, 설비구분 input태그에 값 넣어주고 모달창 닫기
				--------------- */
				eqpTypeModalGrid.on('click',function(ev){
					
					let data = eqpTypeModalGrid.getRow(ev.rowKey);
					let eqpTypeCode = data.eqpTypeCd; // 선택된 설비 구분 코드
					let eqpTypeName = data.eqpTypeNm; // 선택된 설비 구분명
					
					document.getElementById('eqpTypeCd').value = eqpTypeCode;
					document.getElementById('eqpTypeNm').value = eqpTypeName;
					
					document.querySelector('#eqpTypeModal button.btn-close').click();
				});
				
				return eqpTypeModalGrid;
			}
			
			/*------------
			// 탭 버튼 클릭
			----------------*/
			function tabBtnHandler(){
				document.getElementById('select-tab').addEventListener('click', function () {
					selectEqpGrid.refreshLayout();
				});	
			}
			
			/* ---------------
			조회탭 검색 버튼
			--------------- */
			function searchBtn() {
				
				document.getElementById('searchBtn').addEventListener('click', function () {
					let searchedEqpNm = document.getElementById('searchedEqpNm');
					
					// 검색창 글자 안 적으면 전체 조회 ajax
					if (searchedEqpNm.value == null || searchedEqpNm.value == '') {
						selectEqpGrid.unfilter('eqpNm');
						return;
					} else {
						selectEqpGrid.filter('eqpNm', [{code: 'contain', value: searchedEqpNm.value}]);
					}
					
					// ajax로 검색어가 포함된 데이터 ajax로 가져오기
					
				})
			}
			
			
			/* ---------------
			조회탭 검색 초기화 버튼
			--------------- */
			function searchResetBtn() {
				document.getElementById('resetFilter').addEventListener('click', function () {
					selectEqpGrid.unfilter('eqpNm');
					selectEqpGrid.unfilter('eqpType');
					selectEqpGrid.unfilter('eqpSts');
				})
			}
			
			/* ---------------
			조회탭 체크 삭제 버튼
			--------------- */
			function deleteBtn() {
				document.getElementById('deleteBtn').addEventListener('click', function () {
					let data = selectEqpGrid.getCheckedRows();
					
					sweetConfirm('D', function () {
						$.ajax({
							url: '/eqpDelete',
							type: 'post',
							contentType: 'application/json',
							data: JSON.stringify(data),
							success: function (data) {
								if (data > 0) {
									// ajax success
									toastr.success('정상적으로 삭제되었습니다.');
									selectEqpGrid.removeCheckedRows();
								} else {
									// ajax fail
									toastr.error('삭제에 실패했습니다.');  
								}								
							},
							error: function (reject) {
								console.log(reject);
							}
						});	
						
						
					});
				});
				
			}
			
			
			
			/* ---------------
			관리탭 설비목록 모달 시 refresh
			--------------- */
			function eqpListSelect() {
				
				document.addEventListener('shown.bs.modal', function (){
					eqpListModalGrid.refreshLayout();
				});
			}
			
			
			
			
			/* ---------------
			관리탭 설비구분 모달 시 refresh
			--------------- */
			
			function eqpTypeSelect() {
				document.addEventListener('shown.bs.modal', function (){
					eqpTypeModalGrid.refreshLayout();
				});
			}
			
			
			
			
			
			
			
			/* ---------------
			관리탭 form태그 내용으로 insert OR update 하는 버튼
			--------------- */
			function insertUpdateBtn() {
				
				document.getElementById('insertUpdateBtn').addEventListener('click', function () {
					
					// 설비코드 값이 없으면 insert. 있으면 update
					if (document.getElementById('eqpCd').value == '') {
						// insert할 데이터
						let data = {
								eqpCd: document.getElementById('eqpCd').value,
								eqpNm: document.getElementById('eqpNm').value,
								mdNm: document.getElementById('mdNm').value,
								chkCycle: document.getElementById('chkCycle').value,
								actCd: document.getElementById('actCd').value,
								mkDate: document.getElementById('mkDate').value,
								buyDate: document.getElementById('buyDate').value,
								eqpTypeCd: document.getElementById('eqpTypeCd').value,
								eqpTypeNm: document.getElementById('eqpTypeNm').value,
								eqpSts: document.getElementById('eqpSts').value,
								uph: document.getElementById('uph').value,
								highTemp: document.getElementById('highTemp').value,
								lowTemp: document.getElementById('lowTemp').value,
								img: document.getElementById('imgTag').value
						};
						
						// 업로드할 파일 데이터
						var form = new FormData();
				        form.append('img', $('#img')[0].files[0]);
				        console.log(form);
						sweetConfirm('C', function () {
							$.ajax({
					             url : "/result",
					             type : "post",
					             processData : false,
					             contentType : false,
					             data : form,
					             success:function(data) {
					                 console.log(data);
									// ajax success
									toastr.success('정상적으로 저장되었습니다.');
									// document.getElementById('reset').click();
					             },
					             error: function (reject) { 
					                 alert(reject); 
					             }
					        });
							
							
							
							// ajax fail
							toastr.error('저장에 실패했습니다.');  
						});
						
						
					} else {
						sweetConfirm('U', function () {
							// ajax success
							toastr.success('정상적으로 수정되었습니다.');
							// document.getElementById('reset').click();
							
							
							// ajax fail
							toastr.error('수정에 실패했습니다.');  
						});
						
					}
					
				});
				/* 
		
					insert든 update든 완료되면 알림 띄워주고
					화면단에 적힌거 reset버튼 타겟팅 후 click으로 지워준다.
					
					설비코드가 비워져있으면 insert => sweetConfirm('C', function() {})
					설비코드가 비워져있으면 update => sweetConfirm('U', function() {})
					
					sweetConfirm('', function () {
						// ajax success
						toastr.success('정상적으로 저장되었습니다.');
						toastr.success('정상적으로 수정되었습니다.');
						selectEqpGrid.removeCheckedRows();
						// ajax fail
						toastr.error('저장에 실패했습니다.');  
						toastr.error('수정에 실패했습니다.');  
					});
				*/
			}
			
			
			
			/* ---------------
			input#IMG에 값 들어오면 img태그 만들어서 사진 나오는 이벤트
			--------------- */
			function inputImgInteract() {
				img.addEventListener('change', function (event) {
					// 파일명 가져오기
					let index = document.getElementById('img').value.lastIndexOf('\\');
					let fileStr = document.getElementById('img').value.substring(index + 1);
					
					// img태그 생성
					let newImgTag = document.createElement('img');
					newImgTag.setAttribute('id', 'imgTag');
					newImgTag.setAttribute('name', 'imgTag');
					newImgTag.setAttribute('alt', '설비사진');
					newImgTag.setAttribute('width', '300px');
					newImgTag.setAttribute('height', '300px');
					
					// 이미 document에 img태그 존재시 삭제. 미존재시 src 속성 만들어 넣기
					if (document.getElementById('imgTag') != null) {
						document.getElementById('imgTag').remove();
						
						// 새 파일을 고른 경우
						if (fileStr != '') {
							newImgTag.setAttribute('src', 'images/' + fileStr);
						}
					} else {
						newImgTag.setAttribute('src', 'images/' + fileStr);
					}
					
					// document에 삽입
					imgDiv.prepend(newImgTag);
				});
				
			}
			
			
			
			/* ---------------
			초기화 버튼 눌렀을때 img태그 src도 같이 초기화
			--------------- */
			function imgTagReset() {
				reset.addEventListener('click', function () {
					document.getElementById('imgTag').src = '';
				});
			}
			
			
		</script>
	</div>

</body>

</html>