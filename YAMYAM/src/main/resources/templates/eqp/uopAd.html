<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">

<head>
<meta charset="UTF-8">
<title>YAMYAM</title>
<style type="text/css">
	form table {
		font-size: 1em;
		border-top: 3px solid black;
		border-bottom: 2px solid black;
		width: 100%;
		height: 180px;
	}
	
	table tr {
		border-top: 1px solid gainsboro;
	}
	
	form table input[type='text'] {
		width: 180px;
	}
	
	form table input[type='date'] {
		width: 120px;
	}
	
	select option[value=""][disabled] {
	display: none;
	}
	
	form > button {
		float:right;
		margin-top: 10px;
		margin-right:10px;
	}
</style>
</head>

<body>
	<!-- 본문 시작 -->
	<div layout:fragment="content" class="container">
		<h3>설비 비가동 관리</h3>
		<hr>
		
		<div class="row">
			<div class="col-5">
				<h3>설비목록</h3>
				<div id="selectEqp"></div>
			</div>
			<div class="col-7">
				<h3>비가동 이력</h3>
				<ul class="ul-style">
					<li>
						<label for="searchEqpCd">설비코드</label>
						<input type="text" id="searchEqpCd" name="eqpCd" readonly>
						<input type="text" id="searchEqpNm" name="eqpNm" readonly>
					</li>

					<!-- Date Picker -->
					<li>
						<label for="startpicker-input">비가동시작일</label>
						<div class="tui-datepicker-input tui-datetime-input tui-has-focus">
							<input id="startpicker-input" type="text" aria-label="Date">
							<span class="tui-ico-date"></span>
							<div id="startpicker-container" style="margin-left: -1px;"></div>
						</div>
						<span>-</span>
						<div class="tui-datepicker-input tui-datetime-input tui-has-focus">
							<input id="endpicker-input" type="text" aria-label="Date">
							<span class="tui-ico-date"></span>
							<div id="endpicker-container" style="margin-left: -1px;"></div>
						</div>
						<button id="uopRecordSearch" class="btn btn-dark btn-sm">조회</button>
						<button id="clearSearchBox" class="btn btn-dark btn-sm">초기화</button>
					</li>
				</ul>
				<div id="selectUop"></div>
				<br>
				<h3>비가동 등록</h3>
				<form action="">
					<table>
						<tr>
							<th>설비코드</th>
							<td>
								<input type="text" id="eqpCd" name="eqpCd" readonly>
							</td>
							<td></td>
							<th>설비명</th>
							<td>
								<input type="text" id="eqpNm" name="eqpNm" readonly>
							</td>
							<td></td>
							<th>비가동번호</th>
							<td>
								<input type="text" id="uopNo" name="uopNo" readonly>
							</td>
						</tr>
						<tr>
							<th>비가동명</th>
							<td>
								<select name="uopNm" id="uopNm" class="form-select-sm">
									<option class="form-select form-select-sm" value="" disabled selected>비가동명 선택</option>
							        <option value="수리">수리</option>
							        <option value="점검">점검</option>
							        <option value="기타">기타</option>
							    </select>
							</td>
							<td></td>
							<th>작업내용</th>
							<td colspan="4">
								<input type="text" id="uopInfo" name="uopInfo" style="width:510px">
							</td>
							<td></td>
							<th></th>
							<td></td>
						</tr>
						<tr>
							<th colspan="8">
								비가동시작시간&nbsp;
								<input type="datetime-local" id="uopStime" name="uopStime">
								<button type="button" class="btn btn-success btn-sm" id="start" style="margin-right: 40px">시작</button>
								비가동종료시간&nbsp;
								<input type="datetime-local" id="uopEtime" name="uopEtime">
								<button type="button" class="btn btn-success btn-sm" id="end">종료</button>
							</th>
						</tr>
					</table>
					
					<!-- 등록 버튼 누르면 서버에서 전체VO로 받아서 서비스단에서 uopEtime이 없으면 insert. uopEtime이 있으면 update -->
					<button type="button" class="btn btn-dark btn-sm" id="uopInsertUpdate">비가동 등록/해제</button>
					<button type="reset" class="btn btn-dark btn-sm" id="reset">초기화</button>
				</form>
			</div>
		</div>
		
		<script>
			let selectEqpGrid = selectEqpGridInit();	// 설비목록 grid 초기화
			let selectUopGrid = selectUopGridInit();	// 비가동 이력 grid 초기화
			
			datePickerInit();							// 비가돟 이력쪽 datepicker
			uopRecordSearch();							// 비가동 이력쪽 조회버튼 누르면 결과값 가져와서 selectUopGrid에 뿌려주기
			clearSearchBox();							// 비가동 이력쪽 초기화버튼 클릭시 input, datepicker칸 초기화
			
			uopStartBtn();								// 비가동 폼의 비가동시작시간버튼 입력 이벤트
			uopEndBtn();								// 비가동 폼의 비가동종료시간버튼 입력 이벤트
			
			
			// toastr
			toastr.options = {
				    "closeButton": false,
				    "newestOnTop": true,
				    "positionClass": "toast-top-center",
				    "preventDuplicates": true,
				    "extendedTimeOut" : 1500, 
				    "timeOut" : 2500
			}
			
			
			
			/* ---------------
			설비목록 grid 초기화
			--------------- */
			function selectEqpGridInit() {
				let selectEqpGrid = new tui.Grid({
				      el: document.getElementById('selectEqp'),
				      bodyHeight: 600, // 스크롤
				      data: [
				    	{
				    		eqpCd: 'eqp-20221104-001',
				    		eqpNm: '만두소 배합기1',
				    		eqpType: '대기',
				    		eqpSts: '가동'
					    },
				    	{
				    		eqpCd: 'eqp-20221104-002',
				    		eqpNm: '만두소 배합기2',
				    		eqpType: '대기',
				    		eqpSts: '가동'
					    }
					  ],
				      rowHeaders: ['rowNum'],
				      scrollX: false,
				      scrollY: true,
				      columns: [
				        {
				          header: '설비코드',
				          name: 'eqpCd',
					      sortable: true,
					      align: 'center'
				        },
				        {
				          header: '설비명',
				          name: 'eqpNm',
					      sortable: true,
					      align: 'left'
				        },
				        {
				          header: '설비구분',
				          name: 'eqpType',
					      align: 'center',
					      filter: {
					    	  type: 'select'
					      }
				        },
				        {
				          header: '설비상태',
				          name: 'eqpSts',
					      align: 'center',
					      filter: {
					    	  type: 'select'
					      }
				        }
				      ]
				});
				
				/* ---------------
				설비목록 grid 클릭 시, 비가동 등록 폼 및 비가동이력 검색의 설비코드/설비명 입력 이벤트
				--------------- */
				
				selectEqpGrid.on('click', function (ev) {
					let clickedRow = selectEqpGrid.getRow(ev.rowKey);
	
					// 비가동 등록폼쪽
					if (clickedRow.eqpSts != 'N') {
						// 이전에 적혀있는것들 지워주고
						document.getElementById('reset').click();
						
						document.getElementById('eqpCd').value = clickedRow.eqpCd;
						document.getElementById('eqpNm').value = clickedRow.eqpNm;
					}
					
					// 비가동 이력 검색쪽
					document.getElementById('searchEqpCd').value = clickedRow.eqpCd;
					document.getElementById('searchEqpNm').value = clickedRow.eqpNm;
					
				});
				
				return selectEqpGrid;
			}
			
			
			function selectUopGridInit() {
				let selectUopGrid = new tui.Grid({
				      el: document.getElementById('selectUop'),
				      bodyHeight: 200, // 스크롤
				      data: [
				    	{
				    		uopNo: '1',
				    		eqpCd: 'eqp-20221104-001',
				    		eqpNm: '만두소 배합기1',
				    		uopNm: '수리',
				    		uopInfo: '부품교체',
				    		uopStime: '2022-11-17 22:22',
				    		uopEtime: ''
					    },
				    	{
				    		uopNo: '2',
				    		eqpCd: 'eqp-20221104-002',
				    		eqpNm: '만두소 배합기2',
				    		uopNm: '점검',
				    		uopInfo: '부품교체',
				    		uopStime: '2022-11-17 22:22',
				    		uopEtime: '2022-11-17 22:23'
					    }
					  ],
				      rowHeaders: ['rowNum'],
				      scrollX: false,
				      scrollY: true,
				      columns: [
				        {
				          header: '비가동번호',
				          name: 'uopNo',
					      sortable: true,
					      align: 'center'
				        },
				        {
				          header: '설비코드',
				          name: 'eqpCd',
					      sortable: true,
					      align: 'center'
				        },
				        {
				          header: '설비명',
				          name: 'eqpNm',
					      sortable: true,
					      align: 'left'
				        },
				        {
				          header: '비가동명',
				          name: 'uopNm',
					      align: 'left',
					      filter: {
					    	  type: 'select'
					      }
				        },
				        {
				          header: '작업내용',
				          name: 'uopInfo',
					      align: 'left'
				        },
				        {
				          header: '시작시간',
				          name: 'uopStime',
					      align: 'right'
				        },
				        {
				          header: '종료시간',
				          name: 'uopEtime',
					      align: 'right'
				        },
				      ]
				});
				
				
				/* ---------------
				비가동이력 grid 클릭 시 비가동 폼에 종료시간을 제외한 정보 전부 입력 이벤트
				--------------- */
				selectUopGrid.on('click', function (ev) {
					document.getElementById('reset').click();
					
					let clickedRow = selectUopGrid.getRow(ev.rowKey);
					
					if (clickedRow.uopEtime == '' || clickedRow.uopEtime == null) {
						// 이전에 적혀있는것들 지워주고
						
						document.getElementById('uopNo').value = clickedRow.uopNo;
						document.getElementById('eqpCd').value = clickedRow.eqpCd;
						document.getElementById('eqpNm').value = clickedRow.eqpNm;
						document.getElementById('uopNm').value = clickedRow.uopNm;
						document.getElementById('uopInfo').value = clickedRow.uopInfo;
						document.getElementById('uopStime').value = clickedRow.uopStime;
					}
				});
				
				return selectUopGrid;
			}
	
			
			
			/*------------
			datepicker
			----------------*/	
			function datePickerInit() {
				// toast - datepicker
				rangeDatepickerInit('#startpicker-input', '#startpicker-container','#endpicker-input','#endpicker-container')
			}
			
			
			
			/* ---------------
			비가동 이력쪽 조회버튼 누르면 결과값 가져와서 selectUopGrid에 뿌려주기
			--------------- */
			function uopRecordSearch() {
				document.getElementById('uopRecordSearch').addEventListener('click', function () {
					let eqpCd = document.getElementById('searchEqpCd').value;
					let startDay = document.getElementById('startpicker-input').value;
					let endDay = document.getElementById('startpicker-input').value;
					
					console.log(eqpCd, startDay, endDay);
					
					
					// ajax로 해당 설비의 시작일과 마지막일을 들고가서 결과값 가져온 뒤에 selectUopGrid에 resetData()해준다.
				});
			}
			
			
			
			/* ---------------
			비가동 이력쪽 초기화버튼 클릭시 input, datepicker칸 초기화
			--------------- */
			function clearSearchBox() {
				document.getElementById('clearSearchBox').addEventListener('click', function () {
					document.getElementById('searchEqpCd').value = '';
					document.getElementById('searchEqpNm').value = '';
					
					document.getElementById('startpicker-input').value = today;
					document.getElementById('endpicker-input').value = today;
				});
			}
			
			
	
			/* ---------------
			비가동 폼의 비가동시작시간버튼 입력 이벤트
			--------------- */
			function uopStartBtn() {
				document.getElementById('start').addEventListener('click', function () {
					
					console.log('2017-06-01T08:30');
					let date = new Date();
					
					let year = date.getFullYear() 
					let month = ('0' + (date.getMonth() + 1)).slice(-2);
					let day = ('0' + date.getDate()).slice(-2);
					let hour = ('0' + date.getHours()).slice(-2);
					let minute = ('0' + date.getMinutes()).slice(-2);
					
					date = year + '-' + month + '-' + day + ' ' + hour + ':' + minute;
					
					document.getElementById('UOP_STIME').value = date;
				});
			}
			
			
			
			/* ---------------
			비가동 폼의 비가동종료시간버튼 입력 이벤트
			--------------- */
			function uopEndBtn() {
				document.getElementById('end').addEventListener('click', function () {
					
					if (document.getElementById('uopStime').value == '' || document.getElementById('uopStime').value == null) {
						alert('시작버튼을 눌러서 시작시간부터 입력해주세요');
						return;
					}
					
					let date = new Date();
					
					let year = date.getFullYear() 
					let month = ('0' + (date.getMonth() + 1)).slice(-2);
					let day = ('0' + date.getDate()).slice(-2);
					let hour = ('0' + date.getHours()).slice(-2);
					let minute = ('0' + date.getMinutes()).slice(-2);
					
					date = year + '-' + month + '-' + day + ' ' + hour + ':' + minute;
					
					document.getElementById('uopEtime').value = date;
				});
			}
			
			
			
			/* ---------------
			비가동 등록/해제 버튼 누를시 종료시간이 없으면 insert, 있으면 update
			--------------- */
			function uopEndBtn() {
				document.getElementById('uopInsertUpdate').addEventListener('click', function () {
					
					// 종료시간 없으면 insert ajax
					/*
					sweetConfirm('', function () {
						// ajax success
						toastr.success('정상적으로 등록되었습니다.');
						document.getElementById('reset').click();
						// ajax fail
						toastr.error('등록에 실패했습니다.');  
					});
					*/
					
					// 종료시간 있으면 update ajax
					/*
						sweetConfirm('', function () {
						// ajax success
						toastr.success('정상적으로 수정되었습니다.');
						selectEqpGrid.removeCheckedRows();
						document.getElementById('reset').click();
						// ajax fail
						toastr.error('수정에 실패했습니다.');  
					});
					*/
				});
			}
		
		</script>
	</div>


	
</body>

</html>