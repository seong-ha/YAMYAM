<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">
<head>
<meta charset="UTF-8">
<title>YAMYAM</title>

<style>
#od-btn {
	display: inline-block; margin: 0 5px; float: right;
}
#startpicker-input, #endpicker-input {
text-align: center;
}
</style>
</head>
<body>
<div class="container" layout:fragment="content">

	<div id="od-title">
		<h3>완제품 출고 관리</h3>
	</div>
	<div id="prdOutAd-content">
		<div id="input-group">
			<ul class="ul-style">
    
     		<li><label>주문일자</label>
			    <div class="tui-datepicker-input tui-datetime-input tui-has-focus">
			        <input id="startpicker-input" type="text" aria-label="Date">
			        <span class="tui-ico-date"></span>
			        <div id="startpicker-container" style="margin-left: -1px;"></div>
			    </div>
    			<span>-</span>
			    <div class="tui-datepicker-input tui-datetime-input tui-has-focus">
			        <input id="endpicker-input" type="text" aria-label="Date">
			        <span class="tui-ico-date"></span>
			        <div id="endpicker-container" style="margin-left: -1px;"></div>
			    </div>
			    
	    <!-- 버튼 -->
		<button class="btn btn-dark btn-sm" id="searchBtn">조회</button>
		<button  class="btn btn-dark btn-sm" id="cancelBtn">초기화</button></li>
          </ul>
	    </div>
	    
	          <!-- 완제품 재고 현황 Modal -->
      <div class="modal" id="lotSModal" tabindex="-1"
         aria-labelledby="exampleModalLabel" aria-hidden="true">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">완제품 재고 현황</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"
                     aria-label="Close"></button>
               </div>
               <div class="modal-body">
               <div id="lotSModalGrid"></div>
               </div>
            </div>
         </div>
      </div>
	</div>	

	<div id="od-content-2">
		<h4>진행중인 주문서 현황</h4>
		
	<div id="grid"></div>

	</div>
	<br>
	<div id="od-content-3">
		<h4>출고 등록 현황 리스트</h4>

	<div id="od-btn">
	<button class="btn btn-dark btn-sm" id="insertBtn">추가</button>
	<button class="btn btn-dark btn-sm" id="deleteBtn">선택삭제</button>
	<button class="btn btn-dark btn-sm" id="saveBtn">저장</button>
	</div>
	<div id="insertOutGrid"></div>
		</div>

<script>


	/*------------
	// function
	----------------*/
	getOrdIngList();		// DB에서 주문서목록 불러오기
	getOrdOutList();		// DB에서 출고등록목록 불러오기
	//getlotSList();			// DB에서 LOT재고현황 불러오기 
	//ordIngListClick();			// DB에서 LOT재고현황 불러오기 
	searchBtnHandler();		// 조회 버튼 핸들러
	cancelBtnHandler();		// 데이트피커 값 초기화 버튼
	deleteBtnHandler();		// 삭제 버튼 이벤트 핸들러
	
	let lotSModalGrid = lotSGridInit(); 		// 완제품LOT 재고 현황 모달
	let grid = orderGridInit();					// 진행중인 주문서 Grid
	let insertOutGrid = insertGridInit();		// 출고등록 Grid
	
	
	/*------------
	// 데이트피커
	----------------*/
	rangeDatepickerInit('#startpicker-input', '#startpicker-container','#endpicker-input','#endpicker-container')

	
	/*------------
	// 조회버튼 이벤트 핸들러
	----------------*/
	function searchBtnHandler(){
		$('#searchBtn').on('click',function(){
			let getStartDate = $("#startpicker-input").val();
			let getEndDate = $("#endpicker-input").val();
			$.ajax({
				   url:'/ingOrdDetailList',
				   contentType: 'application/json',
				   dataType: "json",
				   method: "GET",
				   data : {
					   "startDate" : getStartDate, "endDate" : getEndDate
				   },
				   success : function(data) {
					   grid.resetData(data);
				   },
				   error : function(reject) {
					   console.log(reject);
				   }
			   })
		});
	}
	
	
	
	  /*------------
	// 주문 조회 초기화 버튼
	----------------*/
	function cancelBtnHandler(){
		$('#cancelBtn').on('click',function(){
			$("#startpicker-input").val(today);
			$("#endpicker-input").val(today);
			
			$.ajax({
				   url:'/ingOrdList',
				   contentType: 'application/json',
				   dataType: "json",
				   method: "GET",
				   success : function(data) {
					   grid.resetData(data);
				   },
				   error : function(reject) {
					   console.log(reject);
				   }
			   })
		});	
	}
	
	
	
    /*------------
	// 주문서 리스트 그리드
	----------------*/
	function orderGridInit(){
	let grid = new tui.Grid({
	    el: document.getElementById('grid'),
	    rowHeaders: ['rowNum'],
	    scrollX: false,
	    scrollY: false,
	    columns: [
	      {
	        header: '주문 일자',
	        align : 'center',
	        name: 'odDate'
	      },
	      {
	        header: '주문 코드',
	        align : 'center',
	        name: 'odCd'
	      },
	      {
	        header: '제품 코드',
	        align : 'center',
	        name: 'prdCd'
	      },
	      {
	        header: '제품명',
	        align : 'center',
	        name: 'prdNm'
	      },
	      {
	        header: '거래처명',
	        align : 'center',
	        name: 'actNm',
	        filter: {type: 'select'}
	      },
	      {
	        header: '주문량',
	        align : 'center',
	        name: 'odAmt'
	      }
	    ]
	  });
		return grid;
    }
    	

	/*------------
	// 주문서 리스트 가져오기
	----------------*/
	  function getOrdIngList() {
          $.ajax({
             url : '/ingOrdList',
             dataType : "json",
             success : function(data) {
            	 grid.resetData(data);
             },
             error : function(reject) {
                console.log(reject);
             }
          })
       }
    
  
	/*------------
	// 주문서 행 클릭 핸들러
	----------------*/
	function ordIngListClick() {
		grid.on('click',function(ev){
			let rowData = grid.getRow(ev.rowKey);
			if(!ev.rowKey) {
				return;
			}
		//let odCd = grid.getValue(ev.rowKey, 'odCd')
		
		if(rowData[i] != null){
	   		 $.ajax({
	             url : '/lotSListModal',
	             dataType : "json",
	             success : function(data) {
	            	 grid.resetData(data);
	   				$('#lotSModal').modal('show');
	   				grid.refreshLayout();
	             },
	             error : function(reject) {
	                console.log(reject);
	             }
	          })
			 
		}
			
		})
	}
	
	
	
	/*------------
	// 완제품 재고 현황 Modal
	----------------*/
	function lotSGridInit() {
		let lotSModalGrid = new tui.Grid({
		    el: document.getElementById('lotSModalGrid'),
		    bodyHeight: 500,
		    rowHeaders: ['rowNum'],
		    scrollX: false,
		    scrollY: true,
		    columns: [
		      {
		        header: '완제품LOT',
		        align : 'center',
		        name  : 'prdLot'
		      },
		      {
		        header: '생산량',
		        align : 'center',
		        name  : 'binAmt'
		      },
		      {
		        header: '출고량',
		        align : 'center',
		        name  : 'bAmt',
		        editor: 'text',
				validation: {
				     dataType: 'text',
				     required: true
				      }
		      },
		      {
		        header: '제조일자',
		        align : 'center',
		        name  : 'podDate'
		      },
		      {
		        header: '유통기한',
		        align : 'center',
		        name  : 'edate'
		      }
		    ]
		  });
			return lotSModalGrid;
	}
    
	
	/*------------
	// 완제품 재고 현황 Modal (DB에서 데이터 가져오기)
	----------------*/
	function getlotSList(){
		lotSModalGrid.on('click',function(){
			   $.ajax({
				   url:'/lotSListModal',
				   dataType: "json",
				   success : function(data) {
					   lotSModalGrid.resetData(data);
				   },
				   error : function(reject) {
					   console.log(reject);
				   }
			   })
			   lotSModalGrid.refreshLayout();
		 });
	}
	
	
    /*------------
	// 출고 등록 그리드
	----------------*/
    function insertGridInit() {
	let insertOutGrid = new tui.Grid({
	    el: document.getElementById('insertOutGrid'),
	    rowHeaders: ['checkbox','rowNum'],
	    scrollX: false,
	    scrollY: false,
	    columns: [
	      {
	        header: '주문 코드',
	        align : 'center',
	        name  : 'odCd'
	      },
	      {
	        header: '제품 코드',
	        align : 'center',
	        name  : 'prdCd'
	      },
	      {
	        header: '완제품LOT',
	        align : 'center',
	        name  : 'prdLot'
	      },
	      {
	        header: '출고량',
	        align : 'center',
	        name  : 'bamt'
	      },
	      {
	        header: '출고 일자',
	        align : 'center',
	        name  : 'bdates'
	      },
	      {
	        header: '제조 일자',
	        align : 'center',
	        name  : 'podDate'
	      },
	      {
	        header: '유통기한',
	        align : 'center',
	        name  : 'edate'
	      },
	      {
	        header: '비고',
	        align : 'center',
	        name  : 'outEtc'
	      }
	    ]
	  });
	  	return insertOutGrid;
	 }
    
    
    /*------------
	// 출고 내역 주문서 리스트 가져오기
	----------------*/
	  function getOrdOutList() {
          $.ajax({
             url : '/ordOutList',
             dataType : "json",
             success : function(data) {
            	insertOutGrid.resetData(data);
             },
             error : function(reject) {
                console.log(reject);
             }
          })
       }
    
    
    
	/*------------
	// 주문서 추가 버튼
	----------------*/
   $('#insertBtn').on('click',function(){
      let rowData = [{odCd: "", prdCd: "", lot: "", outAmt: "", outDate: "", podDate : "" , eDate: ""}]
      insertOutGrid.appendRow(rowData); 
	});
	
	
	/*------------
	// 삭제 버튼 클릭(그리드행 삭제)
	----------------*/	
	function deleteBtnHandler(){
		// grid 선택 행 삭제
		$('#deleteBtn').on('click',function(){
			// sweetalert2
			Swal.fire({
			      title: '정말로 삭제 하시겠습니까?',
			      icon: 'warning',
			      showCancelButton: true,
			      confirmButtonColor: '#3085d6',
			      cancelButtonColor: '#d33',
			      confirmButtonText: '확인',
			      cancelButtonText: '취소',
			      
			    }).then((result) => {
			      if (result.isConfirmed) {
			        Swal.fire(
			          '삭제가 완료되었습니다.'		          
			        )
			        insertOutGrid.removeCheckedRows();
			      }
			    })
			
		});	
	}

	
	
	
</script>
</div>
</body>
</html>